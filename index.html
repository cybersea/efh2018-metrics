<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>EFH Metrics</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <!--Remote -->
    <!--
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src="http://api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/leaflet.esri/1.0.4/esri-leaflet.js"></script>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    -->
    <!-- Updated Remote versions-->
    <script src="http://cdn.leafletjs.com/leaflet/v1.3.1/leaflet.js"></script>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v1.3.1/leaflet.css" />
    <script src="https://unpkg.com/esri-leaflet@2.1.2/dist/esri-leaflet.js"></script>


    <!--Local -->  
    <link href='css/normalize.css' rel="stylesheet">
<!--    <link href="css/leaflet.css" rel="stylesheet"/>-->
    <link href="css/easy-button.css" rel="stylesheet"/>
    
    <script src="js/jquery-1.11.2.min.js"></script>
<!--    <script src="js/leaflet.js"></script>-->
<!--    <script src="js/esri-leaflet.js"></script>    -->
    <script src="js/turf.min.js"></script>
    <script src="js/jquery.tabletoCSV.js"></script>
    <script src="js/easy-button.js"></script>
    <script src="js/typeahead.bundle.min.js"></script>
    
    <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,500,600' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<!--    <script src="https://use.fontawesome.com/dbb89f5a68.js"></script>-->
    <link rel="stylesheet" href="fonts/font-awesome-4.6.3/css/font-awesome.min.css">

    <!-- custom css -->
    <link href="css/site.css" rel="stylesheet">

</head>

<body>
    
    <div id='map'></div>
    
    <div id='layer-control-text'></div>

    <div id="right-panel">
        
        <!-- HTML form for user to select EFH proposal to draw on map -->
        <!-- Note that values for data-nice-name must correspond exactly to attribute names in source GeoJSON data file -->
        <!-- Only Collaborative and Oceana proposals initially visible -->
        <!--        <h2>EFH Proposals</h2>-->

        <div id='poly-search'>
            <i class="fa fa-search"></i>
            <input class="typeahead" type="text" placeholder="Search by polygon name ...">
        </div>
        

        <div id="layer-controls">
            <p class="efh-type">EFH Alternatives</p>
            <!-- Collaborative -->
            <input id="collabLayer" type="checkbox" value="collabLayer" checked>
            <label for="collabLayer" style='color:#E5571D' data-nice-name="Collaborative">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-check-square-o layer-selection-icon"></i></span> 
                Collaborative <span class="layer-counter"><span class="layer-counter-current">0</span>/59</span>
                <button class="layer-unselect-all tooltip" data-tooltip="Remove Proposal from Selection">
                    <i class="fa fa-minus"></i>
                </button>
                <button class="layer-select-all tooltip" data-tooltip="Add Proposal to Selection">
                    <i class="fa fa-plus"></i>
                </button>
            </label>
            <!-- Oceana -->
            <input id="onoLayer" type="checkbox" value="onoLayer" checked>
            <label for="onoLayer" style='color:#6F067B' data-nice-name="Oceana et al.">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-check-square-o layer-selection-icon"></i></span> 
                Oceana et al. <span class="layer-counter"><span class="layer-counter-current">0</span>/68</span>
                <button class="layer-unselect-all tooltip" data-tooltip="Remove Proposal from Selection">
                    <i class="fa fa-minus"></i>
                </button>
                <button class="layer-select-all tooltip" data-tooltip="Add Proposal to Selection">
                    <i class="fa fa-plus"></i>
                </button>
            </label>
            <!-- Midwater Trawlers Cooperative -->
            <input id="mtcLayer" type="checkbox" value="mtcLayer" unchecked>
            <label for="mtcLayer" style='color:#E2007F' data-nice-name="MTC">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-square-o layer-selection-icon"></i></span> 
                MTC <span class="layer-counter"><span class="layer-counter-current">0</span>/13</span>
                <button class="layer-unselect-all tooltip" data-tooltip="Remove Proposal from Selection" disabled = "true">
                    <i class="fa fa-minus"></i>
                </button>
                <button class="layer-select-all tooltip" data-tooltip="Add Proposal to Selection" disabled = "true">
                    <i class="fa fa-plus"></i>
                </button>
            </label>
            <!-- Garibaldi Reef south -->
            <input id="garibLayer" type="checkbox" value="garibLayer" unchecked>
            <label for="garibLayer" id="garibLayer" style='color:#377EB8' data-nice-name="Garibaldi Reef South">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-square-o layer-selection-icon"></i></span> 
                Garibaldi Reef S. <span class="layer-counter"><span class="layer-counter-current">0</span>/1</span>
                <button class="layer-unselect-all tooltip" data-tooltip="Remove Proposal from Selection" disabled = "true">
                    <i class="fa fa-minus"></i>  
                </button>
                <button class="layer-select-all tooltip" data-tooltip="Add Proposal to Selection" disabled = "true">
                    <i class="fa fa-plus"></i>
                </button>
            </label>
            <!-- Rittenburg Bank -->
            <input id="rittLayer" type="checkbox" value="rittLayer" unchecked>
            <label for="rittLayer" style='color:#650B0B' data-nice-name="Rittenburg Bank">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-square-o layer-selection-icon"></i></span> 
                Rittenburg Bank <span class="layer-counter"><span class="layer-counter-current">0</span>/1</span>
                <button class="layer-unselect-all tooltip" data-tooltip="Remove Proposal from Selection" disabled = "true">
                    <i class="fa fa-minus"></i>
                </button>
                <button class="layer-select-all tooltip" data-tooltip="Add Proposal to Selection" disabled = "true">
                    <i class="fa fa-plus"></i>
                </button>
            </label>
             <!-- Potato Bank -->
            <input id="potatoLayer" type="checkbox" value="potatoLayer" unchecked>
            <label for="potatoLayer" style='color:#E9BD02' data-nice-name="Potato Bank">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-square-o layer-selection-icon"></i></span> 
                Potato Bank <span class="layer-counter"><span class="layer-counter-current">0</span>/2</span>
                <button class="layer-unselect-all tooltip" data-tooltip="Remove Proposal from Selection" disabled = "true">
                    <i class="fa fa-minus"></i>
                </button>
                <button class="layer-select-all tooltip" data-tooltip="Add Proposal to Selection" disabled = "true">
                    <i class="fa fa-plus"></i>
                </button>
            </label>
            <!-- 
            <input id="phLayer" type="checkbox" value="phLayer" checked>
            <label for="phLayer" style='color:#00E575' data-nice-name="Priority Habitats in RCA">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-check-square-o layer-selection-icon"></i></span> 
                Priority Hab <span class="layer-counter"><span class="layer-counter-current">0</span>/36</span>
                <button class="layer-unselect-all tooltip" data-tooltip="Remove Proposal from Selection">
                    <i class="fa fa-minus"></i>
                </button>
                <button class="layer-select-all tooltip" data-tooltip="Add Proposal to Selection">
                    <i class="fa fa-plus"></i>
                </button>
            </label>
            <p class="efh-type">Other EFH Proposals</p>
            <input id="fmaLayer" type="checkbox" value="fmaLayer" unchecked>
            <label for="fmaLayer" id="fmaLayer" style='color:#377EB8' data-nice-name="FMA">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-square-o layer-selection-icon"></i></span> 
                FMA <span class="layer-counter"><span class="layer-counter-current">0</span>/1</span>
                <button class="layer-unselect-all tooltip" data-tooltip="Remove Proposal from Selection" disabled = "true">
                    <i class="fa fa-minus"></i>  
                </button>
                <button class="layer-select-all tooltip" data-tooltip="Add Proposal to Selection" disabled = "true">
                    <i class="fa fa-plus"></i>
                </button>
            </label>
            <input id="greenpeaceLayer" type="checkbox" value="greenpeaceLayer" unchecked>
            <label for="greenpeaceLayer" style='color:#0F6001' data-nice-name="Greenpeace">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-square-o layer-selection-icon"></i></span> 
                Greenpeace <span class="layer-counter"><span class="layer-counter-current">0</span>/9</span>
                <button class="layer-unselect-all tooltip" data-tooltip="Remove Proposal from Selection" disabled = "true">
                    <i class="fa fa-minus"></i>
                </button>
                <button class="layer-select-all tooltip" data-tooltip="Add Proposal to Selection" disabled = "true">
                    <i class="fa fa-plus"></i>
                </button>
            </label>
            <input id="mbnmsLayer" type="checkbox" value="mbnmsLayer" unchecked>
            <label for="mbnmsLayer" style='color:#E9BD02' data-nice-name="MBNMS">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-square-o layer-selection-icon"></i></span> 
                MBNMS <span class="layer-counter"><span class="layer-counter-current">0</span>/15</span>
                <button class="layer-unselect-all tooltip" data-tooltip="Remove Proposal from Selection" disabled = "true">
                    <i class="fa fa-minus"></i>
                </button>
                <button class="layer-select-all tooltip" data-tooltip="Add Proposal to Selection" disabled = "true">
                    <i class="fa fa-plus"></i>
                </button>
            </label>
            <input id="mciLayer" type="checkbox" value="mciLayer" unchecked>
            <label for="mciLayer" style='color:#650B0B' data-nice-name="MCI">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-square-o layer-selection-icon"></i></span> 
                MCI <span class="layer-counter"><span class="layer-counter-current">0</span>/25</span>
                <button class="layer-unselect-all tooltip" data-tooltip="Remove Proposal from Selection" disabled = "true">
                    <i class="fa fa-minus"></i>
                </button>
                <button class="layer-select-all tooltip" data-tooltip="Add Proposal to Selection" disabled = "true">
                    <i class="fa fa-plus"></i>
                </button>
            </label>
            <input id="noneLayer" type="checkbox" value="noneLayer" unchecked>
            <label for="noneLayer" style='color:#0F97A3' data-nice-name="None">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-square-o layer-selection-icon"></i></span> 
                None <span class="layer-counter"><span class="layer-counter-current">0</span>/22</span>
                <button class="layer-unselect-all tooltip" data-tooltip="Remove Proposal from Selection" disabled = "true">
                    <i class="fa fa-minus"></i>
                </button>
                <button class="layer-select-all tooltip" data-tooltip="Add Proposal to Selection" disabled = "true">
                    <i class="fa fa-plus"></i>
                </button>
            </label>
            -->
        </div>

        <div id='ui-controls'>
            <button value="Zoom" class="layer-ui-button" id="zoom">Zoom to selection <i class="fa fa-arrows-alt"></i></button>
            <button value="Clear" class="layer-ui-button" id="clear">Clear selection <i class="fa fa-ban"></i></button>
        </div>
    </div>
    <!-- end right-panel -->
    
    <!-- Side panel Div   -->
    <div id='side-panel'>
        <h1>West Coast Groundfish<br> Essential Fish Habitat</h1>
        <h2 class='side-panel-header'>Alternatives Analysis Metrics</h2>
        <div id='panel-tabs'>
            <button class='selected' value='summary-panel'>Summary</button>
            <button value='polygons-panel'>Polygons <span id="poly-count">(0)</span></button>
            <button value='info-panel'>Info</button>
        </div>
        <div class='side-panel' id='summary-panel'>
            <!-- <h3 id='poly-count'></h3> -->
            <div class="table-wrapper"><table id="summary-metrics"></table></div>
            <span class='start-text'>
                <p>Click on a polygon on the map to add or remove it from the selection.</p>
                <p style="text-align:center">OR</p>
                <p>Select all or unselect all polygons from a proposal or alternative using the <i class="fa fa-plus"></i> or <i class="fa fa-minus"></i> icon next to its name.</p>
                <br>
                <p>A summary of metrics for all selected polygons will display here.</p>
                <p>To avoid double-counting in the summary metrics, if you select a polygon that overlaps a current selection, the overlapping polygon will be removed from the selection.</p>
                <br>
                <p>For the best experience, use the Chrome browser.  Other browsers have not been thoroughly tested.</p>
            </span>
        </div>
        <div class='side-panel' id='polygons-panel'>
            <div class="table-wrapper"><table id="polygon-metrics" class="data"></table></div>
            <button id='download-csv'>Download CSV File</button>
            <span class='start-text'>
                <p>Click on a polygon on the map to add or remove it from the selection.</p>
                <p style="text-align:center">OR</p>
                <p>Select all or unselect all polygons from a proposal or alternative using the <i class="fa fa-plus"></i> or <i class="fa fa-minus"></i> icon next to its name.</p>
                <br>
                <p>A table listing all the selected polygons and their metrics will display here.</p>
                <p>To avoid double-counting in the summary metrics, if you select a polygon that overlaps a current selection, the overlapping polygon will be removed from the selection.</p>
                <br>
                <p>For the best experience, use the Chrome browser.  Other browsers have not been thoroughly tested.</p>
            </span>
        </div>
        <div class='side-panel' id='info-panel'>
            <h2>Background</h2>
        <p>The <a href="http://www.pcouncil.org/" target="_blank">Pacific Fishery Management Council</a> (Council) is currently reviewing <a href="http://www.pcouncil.org/groundfish/groundfish-essential-fish-habitat/" target="_blank">Groundfish Essential Fish Habitat</a> Conservation Areas <a href="http://www.westcoast.fisheries.noaa.gov/fisheries/management/groundfish_closures/essential_fish.html" target="_blank">(EFHCA)</a> and the <a href="http://www.westcoast.fisheries.noaa.gov/fisheries/management/groundfish_closures/rockfish_areas.html" target="_blank">Trawl Rockfish Conservation Area</a> (RCA) off the West Coast of the United States.  The Council is evaluating alternatives that include areas to be closed to commercial trawl fishing, as well as currently closed areas to be reopened. These areas are referred to as polygons.</p>
        <p>Each EFH alternative or set of polygons, other than Alternative 2.b. (Priority Habitats in the trawl RCA), is labeled according to the group that proposed the areas for consideration. The EFH Alternatives are:</p>
            <ul>
                <li>Collaborative: Alternative 1.b. </li>
                <li>Oceana et al: Alternative 1.c. </li>
                <li>Priority Hab: Alternative 2.b. Priority habitats for groundfish within the trawl RCA</li>   
            </ul>
        <p>Other EFH proposals were submitted to the Council, but are not being analyzed as stand-alone alternatives.  They are included here to inform the Council's decision-making process.  They include:</p>
            <ul>
                <li>FMA: Fishermen's Marketing Association</li>
                <li>GFNMS: Greater Farallones National Marine Sanctuary</li>
                <li>Greenpeace</li>
                <li>MBNMS: Monterey Bay National Marine Sanctuary</li>
                <li>MCI: Marine Conservation Institute</li>
                <li>None: Polygons that were identified byt the Collaborative group, but were not included in their final proposal</li>
            </ul>            
        <p>During this evaluation, the Council will consider the importance of the habitat to groundfish (i.e., rockfish, flatfish) and other environmental considerations, as well as the economic impacts and benefits to the fishing and associated businesses and communities before identifying their preferred configuration of EFHCAs.</p>
        <p>In addition to EFHCA changes, the Council is considering modifications to the trawl RCA, ranging from status quo, to complete removal, to retaining portions that would still be closed to bottom trawling, for the purposes of species conservation.  To view the current trawl RCA boundaries, and other reference layers, hover over the layers icon in the upper right of the map and select the layer's checkbox.</p>

        <h2>How to Use this Tool</h2>
        <p>This tool allows a user to select a custom set of EFHCA alternative polygons and see a summary of the metrics for their set. </p>
        <ul>
            <li>Hover over a polygon to view its metrics</li>
            <li>Click a polygon on the map to add or remove it from the selection</li>
            <li>Zoom to a polygon by entering its name in the search box</li>        <li>Toggle a checkbox in the right panel to draw or remove an alternative's or proposal's polygons from the map</li>
            <li>Click the <i class="fa fa-plus"></i> icon next to an alternative or proposal to select all of its polygons</li>
            <li>Click the <i class="fa fa-minus"></i> icon next to an alternative or proposal to unselect all of its polygons</li> 
            <li>View the count of selected polygons out of the total polygons for each proposal or alternative next to its name</li>
            <li>Hover over the layers icon in the upper right of the map to select additional layers to draw on the map</li>
            <li>View summary metrics for all selected polygons in the Summary Tab</li>
            <li>View and download a table of individual metrics for selected polygons in the Polygons Tab</li>

        </ul>
        <p>To avoid double-counting in the summary metrics, if you select a polygon that overlaps a current selection, the overlapping polygon will be removed from the selection.</p>
        <p>For the best experience, use the Chrome browser.  Other browsers have not been thoroughly tested.</p>
            
        <h2>Credits</h2>
        <p>The Council, NOAA, National Marine Fisheries Service (NMFS), scientists, tribes, fishermen, and non-governmental organizations laid the analytical groundwork for this review through  a multi-year synthesis of new data sets and analyses.  Results of the Groundfish Essential Fish Habitat (EFH) Review are available through the <a href="http://efh-catalog.coas.oregonstate.edu/overview/" target="_blank">EFH Catalog</a> as well as the <a href="http://efh-viewer.coas.oregonstate.edu/efh/" target="_blank">EFH Viewer</a>.</p>
        <p>The EFH/RCA Project Team has produced an <a href="http://www.pcouncil.org/wp-content/uploads/2016/11/F4a_Project_Team_Report_EFHRCA_Modifications_Analytical_Doc_NOV2016BB.pdf" target="_blank">analytical report</a> which is the basis for the metrics in this tool.</p>
        <p>Web Development by Allison Bailey, <a href="http://www.soundgis.com" target="_blank">Sound GIS</a></p>
        </div>
    </div>

    <!--  GeoJSON source data (var proposals_metrics)   -->
    <script src="data/efh_proposals_metrics.js"></script>
    <!--  JSON with concat_id and list of unique 1km cells with corspg presence (var corspg1km_proposals)   -->
    <script src="data/corspg1km_proposals.js"></script>
    
    <!--  Main mapping script   -->
    <script>
        // instantiate the Leaflet map
        var options = {
            center: [41, -121.2],
            zoom: 6,
            dragging: true,
            zoomControl: true
        }
        var map = L.map('map', options);

        // Base Maps
        // ESRI Oceans Base Map
        var esri_ocean = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Sources: GEBCO, NOAA, CHS, OSU, UNH, CSUMB, National Geographic, DeLorme, NAVTEQ, and Esri',
            maxZoom: 11
        });
        
        // Nautical Charts - Image Service
        var rnc_image = L.esri.imageMapLayer({
            url: "https://seamlessrnc.nauticalcharts.noaa.gov/arcgis/rest/services/RNC/NOAA_RNC/ImageServer",
            attribution: 'NOAA Office of Coast Survey',
            position: "back"
        });
        rnc_image.on('load', function(e){ });
        
        // Add base layers to map
        //  rnc_image.addTo(map); 
        esri_ocean.addTo(map);
        

        var baseLayers = {
            "ESRI Oceans": esri_ocean,
            "Nautical Charts": rnc_image
        };

        L.control.scale().addTo(map); // Add scale bar
        
        // Add home button - zooms to full extent when clicked
        var homeBtn = L.easyButton('fa-home', function(btn, map){
//            map.setView([41, -121.2]);
//            map.setZoom(6);
            map.setView([41, -121.2],6,{reset: true})
        }).addTo(map);
        
        
        // Create a geoJSON layer of all polygons for search function 
        var allpolys = L.geoJson(proposals_metrics);
        // Globals to store the polygon names and associate boundaries
        var poly_names = [];
        var poly_bounds = {};
        // Get the polygon names and associated boundaries
        allpolys.eachLayer(function(layer){
            poly_names.push(layer.feature.properties.SiteName);
            poly_bounds[layer.feature.properties.SiteName] =  layer.getBounds()
        });

        
        // Create Info Box for display of feature data on hover
        drawInfo();

        // Call function to create user interface for interacting with selected set
        buildUI();


        // Style info for individual proposal layers
        // proposer must match source data from GeoJson file
        var layerInfo = {
            collabLayer: {
                proposer: "Collaborative",
                color: "#E5571D"
            },
            onoLayer: {
                proposer: "Oceana et al.",
                color: "#6F067B"
            },
             mtcLayer: {
                proposer: "MTC",
                color: "#E2007F"
            },
            garibLayer: {
                proposer: "Garibaldi Reef South",
                color: "#377EB8"
            },
            rittLayer: {
                proposer: "Rittenburg Bank",
                color: "#650B0B"
            },
            potatoLayer: {
                proposer: "Potato Bank",
                color: "#E9BD02"
            },
//            greenpeaceLayer: {
//                proposer: "Greenpeace",
//                color: "#0F6001"
//            },
//            noneLayer: {
//                proposer: "None",
//                color: "#0F97A3",
//            },  
//            phLayer : {
//                proposer: "Priority Habitats in RCA",
//                color: "#00E575",
//            }
        };

        var geoJsonLayers = {}; // global to store all the geoJSON layers
        var selectedSet = {}; // global for selected features
        

        // Create individual geoJson Layers for each proposal
        for (var lyr in layerInfo) {

            geoJsonLayers[lyr] = L.geoJson(proposals_metrics, {
                filter: function (feature) {
                    if (feature.properties.Alternative == [layerInfo[lyr].proposer]) {
                        return feature;
                    }
                },
                style: function (feature) {
                    var opcty;
                    if (feature.properties.RegAction == "reopen")
                        opcty = 0.1;
                    else if (feature.properties.RegAction == "close")
                        opcty = 0.4;
                    styles = {
                        color: layerInfo[lyr].color,
                        fillColor: layerInfo[lyr].color,
                        fill: true,
                        weight: 2,
                        fillOpacity: opcty
                    }
                    return styles
                },
                onEachFeature: function (feature, layer) {
                    layer.on({
                        mouseover: highlightFeature,
                        mouseout: resetHighlight,
                        click: function(e){
                            toggleSelected(e.target);
                            //selected(e.target);
                        },
                    });
                }
            })//.addTo(map);

            geoJsonLayers[lyr].startStyle = styles

        } // end of loop through all geoJSON layers
        
        // Add only Collaborative and Oceana layers to map to start
        geoJsonLayers["onoLayer"].addTo(map);
        geoJsonLayers["collabLayer"].addTo(map);
        
        // Supplemental Layer styles
        var depLineWeight = 2;
        var depOpacity = 1;
        
        var latStyles = {
            color: "black",
            weight: 1,
            opacity: depOpacity
        }      
        var dep30Styles = {
            color: "#006400",
            weight: depLineWeight,
            opacity: depOpacity
        }       
        var dep100Styles = {
            color: "#eead0e",
            weight: depLineWeight,
            opacity: depOpacity
        }
        var dep150Styles = {
            color: "#8b2500",
            weight: depLineWeight,
            opacity: depOpacity
        }        
        var dep700Styles = {
            color: "#104e8b",
            weight: depLineWeight,
            opacity: depOpacity
        }  
        var tribalUAStyles = {
            color: "#594600",
            weight: 2,
            opacity: 1
        } 
        var eezStyles = {
            fillColor: "#7f7f7f",
//            stroke: false,
            fillOpacity: 0.3,
            color: "black",
            weight: 1,
            opacity: 0.8            
        }        
        var eezLnStyles = {
            color: "#7f7f7f",
            weight: 1,
            opacity: 1
        }       
        var stateStyles = {
            color: "#7f7f7f",
            weight: 1,
            opacity: 1
        }
        var efhcaStyles = {
            fillColor: "#7f7f7f",
            fillOpacity: 0.3,
            color: "black",
            weight: 1,
            opacity: 1            
        }
        var efh700Styles = {
            fillColor: "#7f7f7f",
            fillOpacity: 0.3,
            color: "black",
            weight: 1,
            opacity: 1            
        }
        var rcaStyles = {
            fillColor: "#737300",
            fillOpacity: 0.3,
            color: "#343434",
            weight: 1,
            opacity: 1            
        }
        
        sources = {
            "eez": "data/eez_py.geojson",
            "eez_ln": "data/eez_ln.geojson",
            "lat": "data/strata_lat.geojson",
            "dep30fm": "data/rca_30fm.geojson",
            "dep100fm": "data/rca_100fm.geojson",
            "dep150fm": "data/rca_150fm.geojson",
            "dep700fm": "data/efh_700fm.geojson", 
            "tribalUA_ln": "data/tribalUA_ln.geojson",
            "state_ln": "data/state_ln.geojson",
            "efhca":"data/efh_consarea_py.geojson",
            "efh700":"data/efh_700fm_py.geojson",
            "rca":"data/RCA_TrawlGF_MarAprSepOct.geojson",    
        }
        
        styles = {
            "eez": eezStyles,
            "eez_ln": eezLnStyles,
            "lat": latStyles,
            "dep30fm": dep30Styles,
            "dep100fm": dep100Styles,
            "dep150fm": dep150Styles,
            "dep700fm": dep700Styles,
            "tribalUA_ln": tribalUAStyles,
            "state_ln": stateStyles,
            "efhca":efhcaStyles,
            "efh700":efh700Styles,
            "rca":rcaStyles,
        }
       
        var data = {}; // object to hold JSON data for each layer
        var layers = {}; // object to hold Leaflet GeoJSON layers
        
        // 
        $.when(
                $.getJSON(sources["eez_ln"], function(d) {
                    data["eez_ln"] =  d;
                }),
                $.getJSON(sources["state_ln"], function(d) {
                    data["state_ln"] =  d;
                }),
                $.getJSON(sources["lat"], function(d) {
                    data["lat"] =  d;
                }),
                 $.getJSON(sources["dep30fm"], function(d) {
                    data["dep30fm"] =  d;
                }),
                 $.getJSON(sources["dep100fm"], function(d) {
                    data["dep100fm"] =  d;
                }),
                 $.getJSON(sources["dep150fm"], function(d) {
                    data["dep150fm"] =  d;
                }),
                 $.getJSON(sources["dep700fm"], function(d) {
                    data["dep700fm"] =  d;
                }),
                  $.getJSON(sources["tribalUA_ln"], function(d) {
                    data["tribalUA_ln"] =  d;
                }),  
                $.getJSON(sources["efhca"], function(d) {
                    data["efhca"] =  d;
                }),  
                $.getJSON(sources["efh700"], function(d) {
                    data["efh700"] =  d;
                }),
                $.getJSON(sources["rca"], function(d) {
                    data["rca"] =  d;
                })                
        ).then(function() {

            // send complete data object to another function to create layers, etc.
            drawMap(data);
            
            // Draw legend with Leaflet GeoJSON layers
            drawSwitcher(layers);
            

        });
        

        // Use the GeoJSON input data to create Leaflet GeoJSON layers for map
        function drawMap(data){
            
            for (k in data){ // loop through each input source data layer
                    
                // Create Leaflet GeoJSON layer with source GeoJSON data
                var layer = L.geoJson(data[k], {
                    style: function (feature) {  // style for each GeoJSON feature
                        return styles[k]
                    }
                })
                // Initial state of all layers is off. 
                // layer.addTo(map);
                
                layers[k] = layer;
                
            } // end loop for all source data layers
            
            // Add specific layers to draw on initial load here, if desired
            layers["tribalUA_ln"].addTo(map);
            
            // Make sure EFH and RCA polygons are always on bottom
            //  to avoid interference with Proposal selection and hover functions
            map.on('overlayadd', function(e){
                if (e.name.indexOf('EFH') >= 0 || e.name.indexOf('RCA') >= 0){
                    e.layer.bringToBack();
                } 
            })

                        
        } // end drawMap()
  
        
        function drawSwitcher(layers){
            
            // Layer Switcher   
            // Not sure how the order is determined.  Seems to vary.
            // Doesn't seem to matter if it is called from $.when/.then, or from drawMap() function
            
            var layerLabels = {
                "<b style='color:#7f7f7f'>EEZ</b>": layers["eez_ln"],
                "<b style='color:#7f7f7f'>State Waters</b>": layers["state_ln"],
                "<b style='color:black'>Latitude Breaks</b>": layers["lat"],
                "<b style='color:#006400'>30 fathoms</b>": layers["dep30fm"],
                "<b style='color:#eead0e'>100 fathoms</b>": layers["dep100fm"],
                "<b style='color:#8b2500'>150 fathoms</b>": layers["dep150fm"],
                "<b style='color:#104e8b'>700 fathoms</b>": layers["dep700fm"],
                "<b style='color:#594600'>Tribal U&A</b>": layers["tribalUA_ln"],
                "<b style='color:#7f7f7f'>EFH Conservation Areas</b>": layers["efhca"],
                "<b style='color:#7f7f7f'>EFH 700-fm Closure</b>": layers["efh700"],
                "<b style='color:#737300'>Trawl RCA</b>": layers["rca"],
            }

            var switcher = L.control.layers(baseLayers, layerLabels, {
                collapsed: true});
            switcher.addTo(map); 
            
            // Add text label next to layer switcher control
            $( "#layer-control-text" ).html( "<p>Reference<br>Layers</p>" );
            

            // Remove text first time layer switcher is used
            // This seems a little funky, so don't use it for now
//            switcher.getContainer().addEventListener("mouseenter", function( event ) {   
//                // highlight the mouseenter target
//                $("#layer-control-text").hide();
//            }, false);  
 
        } // end drawSwitcher()


        // Select or unselect feature depending on its current state
        function toggleSelected(layer){

            var id = layer.feature.properties.concat_id;
            
            if ( selectedSet.hasOwnProperty(id) ){ // in selected set
                
                // Unselect it
                unselected(layer);              
                
            } else { // If already in selected set

                // Select it
                selected(layer);

            }           
        } // end toggleSelected()
        
 
        // Runs when a feature is selected
        function selected(layer) {

            var data = layer.feature.properties;
            var id = layer.feature.properties.concat_id;
            var overlapping = [];

            // If it isn't already selected, add to set and change style
            //  otherwise, unselect it

            // Change Styles 
            layer.setStyle({
                color: "yellow",
            });
            layer.bringToFront();
            
            // Test if it overlaps any current selections
            for ( var i in selectedSet ){
                var feat2compare = selectedSet[i];
                if (isOverlapped(layer, feat2compare)) {
                    // if a current feature is overlapped by selection, add to list
                    overlapping.push(feat2compare);
                }
            }                

            // Add selected feature to the selected set - concat_id is object key
            selectedSet[id]= layer;

            // Add the feature's stats to the summary statistics
            updateSummmary();

            // Add the feature's metrics to the polygon table
            updatePolyTable(data);

            // increase layer control counter by 1 for this proposal
            var $layerCounter = $('label[data-nice-name*="'+data.Alternative+'"]').find('.layer-counter-current');
            var currentValue = +$layerCounter.html(); // the '+' turns it into a number
            $layerCounter.html(currentValue + 1);

            // Unselect any overlapping features
            overlapping.forEach(function (layer) {
                unselected(layer);
            });
            
        } // end selected()

        // Runs when a feature is removed from selection 
        function unselected(layer) {

            // var layer = e.target;
            var data = layer.feature.properties;
            var id = layer.feature.properties.concat_id;
            var proposer = layer.feature.properties.Alternative;

            // If it is selected, remove from selected set object and revert style   
            if (selectedSet.hasOwnProperty(id)){

                // Remove poly from selected set
                delete selectedSet[id];
                
                // Get original color of layer based on proposer
                for (lyr in layerInfo) {
                    if (proposer === layerInfo[lyr].proposer) {
                        var strokeColor = layerInfo[lyr].color
                    }
                }

                // Change color back to original 
                layer.setStyle({
                    color: strokeColor,
                });
                // Following causes errors if layer is not currently visible
                //  layer.bringToFront();
            }

            // decrease layer control counter by 1 for this proposal
            var $layerCounter = $('label[data-nice-name*="'+data.Alternative+'"]').find('.layer-counter-current');
            var currentValue = +$layerCounter.html(); // the '+' turns it into a number
            $layerCounter.html(currentValue - 1);

            // Remove the feature's stats from the summary statistics
            updateSummmary();

        } // end unselected()

        // Determine if two polygons overlap
        function isOverlapped(feature1, feature2) {

            // Input is two Leaflet layer polygons 
            // Convert polys GeoJSON
            var poly1 = feature1.toGeoJSON();
            var poly2 = feature2.toGeoJSON();

            // Turf Intersection function
            var intersection = turf.intersect(poly1, poly2);

            // Only want poly overlaps, not shared boundary intersections
            if (intersection) {
                if (intersection.geometry.type === "Polygon") {
                    return feature2;
                } else {
                    return false
                }
            } else {
                return false
            }

        } // end isOverlapped()

        // Create an array of Leaflet Bounds for each feature
        function getSelectedBounds() {

            var selectedBounds = [];
            
            // Get bounds for selected set of layers
            for ( var i in selectedSet ){
                selectedBounds.push(selectedSet[i].getBounds())
            }

            return selectedBounds;

        } // end getSelectedBounds()

        function zoomToSelected() {

            // Get the bounds of currently selected features
            var bounds = getSelectedBounds();

            // Zooms to currently selected polygons
            map.fitBounds(getSelectedBounds());

        } // end zoomToSelected()


        // Clear all selected polygons
        function clearSelected() {

            for ( var i in selectedSet ){

                var layer = selectedSet[i];
                var proposer = layer.feature.properties.Alternative;

                // Get original color of layer based on proposer
                for (lyr in layerInfo) {
                    if (proposer === layerInfo[lyr].proposer) {
                        var strokeColor = layerInfo[lyr].color
                    }
                }

                // Change color back to original 
                layer.setStyle({
                    color: strokeColor,
                });

                $('#zoom').removeClass('available');
                $('#clear').removeClass('available');
            }

            $('.layer-counter-current').html(0);
                        
            selectedSet = {};  // remove all layers from selected set

            buildSummary() // re-create empty summary table

            buildPolyTable() // re-create empty polygon table
        }

        // Runs on mouseover of a feature - updates style and grabs data for info box
        function highlightFeature(e) {

            var layer = e.target;

            // Change Styles to make outline wider
            layer.setStyle({
                weight: 5,
                dashArray: '',
            });

            if (!L.Browser.ie && !L.Browser.opera) {
                layer.bringToFront();
            }

            // Update the info box               
            updateInfo(layer)

            $(".poly-info").show(); // Show the info box

        } // end highlightFeature()

        // Runs when mouseout of feature - Returns feature style to original
        function resetHighlight(e) {

            // Function that when mouseout of feature
            var layer = e.target;

            layer.setStyle({
                weight: 2
            })

            $(".poly-info").hide(); // Hide the info box

        } // end resetHighlight()

        function drawInfo() {

            // create a new Leaflet control object, and position it lower right
            var info = L.control({
                position: 'bottomright'
            });
            info.onAdd = function (map) { // when info control is added to map
                    // Create a div to hold the info box with a class name of "info"
                    var div = L.DomUtil.create('div', 'poly-info');
                    // return empty div to be added to map
                    return div;
                }
                // Add empty info div to map
            info.addTo(map);
            $(".poly-info").hide(); // hide empty info box until populated

        } // end drawInfo()


        function updateInfo(layer) {

            // variable to access layer properties
            var data = layer.feature.properties;

            // populate html variable with header - Site name
            // and values for the specified attributes using the 
            // layer (feature) that was passed to this function
            var html = "<h3>" + data.SiteName + "</h3>" // +
            html += "<br>" + "<b>Action: </b>" + data.RegAction;
            html += "<br>" + "<b>Alternative: </b>" + data.Alternative;
            html += "<br>" + "<b>Area (sq mi): </b>" + sqm2sqmi(data.SiteAreaM2);
            html += "<br>" + "<b>Hard Substrate: </b>" + pct(data.hard, data.SiteAreaM2);
            html += "<br>" + "<b>Mixed Substrate: </b>" + pct(data.mixed, data.SiteAreaM2);
            html += "<br>" + "<b>Soft Substrate: </b>" + pct(data.soft, data.SiteAreaM2);
            html += "<br>" + "<b>Unknown Substrate: </b>" + pct(data.unknown, data.SiteAreaM2);
            html += "<br>" + "<b>Canyons & Gullies: </b>" + pct(data.CynAreaM2, data.SiteAreaM2);
            html += "<br>" + "<b>Seamounts: </b>" + pct(data.SmtAreaM2, data.SiteAreaM2);
            html += "<br>" + "<b>Corals & Sponges</b> (1 km blocks): " + data.corspg_cnt;
            html += "<br>" + "<b>OFS 20% HSP: </b> " + pct(data.OF20AreaM2, data.SiteAreaM2);
            html += "<br>" + "<b>Conserv. Value Mean: </b> " + rnd(data.cv_mean, 2);
            html += "<br>" + "<b>Conserv. Value Variance: </b> " + rnd(data.cv_var, 2);            
            // Remove all socioeconomic data for now
//            if (data.VesCount >= 3 || data.VesCount == 0) {
//                html += "<br>" + "<b>Trawl Tow Length (mi): </b>" + m2mi(data.TowLenM);
//                html += "<br>" + "<b>Total Catch (MT): </b> " + rnd(data.Total_MT,1);
//                html += "<br>" + "<b>Total Ex-Vessel Value: </b> " + dollars(data.Total_Rev);
//            } else {
//                html += "<br>" + "<b>Trawl Tow Length: </b> **";
//                html += "<br>" + "<b>Total Catch (MT): </b> **";
//                html += "<br>" + "<b>Total Ex-Vessel Value: </b> **";
//            }     

            // Assign the html content to the info box using JQuery selector
            $(".poly-info").html(html);

        } // end updateInfo()

        function buildUI() {
            
            // Perform following actions When the DOM object with id of "ui-controls" is changed
            // i.e., the user selects an option from the HTML form
            $('#ui-controls button').click(function () {
                // Set attribute to user selection from pull-down menu
                attribute = $(this).val();
                // Re-draw map with new attribute
                if (attribute === "Zoom" && Object.keys(selectedSet).length > 0) {
                    zoomToSelected();
                }
                if (attribute === "Clear") {
                    clearSelected();
                }

            });

            // Toggle layers on and off
            $('#layer-controls input').change(function () {

                var targetLayer = $(this).val();
                var icon = $('label[for='+targetLayer+']').find('.layer-selection-icon');
                var selBtn = $('label[for='+targetLayer+']').find('.layer-select-all');
                var unselBtn = $('label[for='+targetLayer+']').find('.layer-unselect-all');
                if (this.checked) {
                    icon.removeClass('fa-square-o').addClass('fa-check-square-o');
                    map.addLayer(geoJsonLayers[targetLayer]);
                    // enable select and unselect all buttons
                    selBtn.prop('disabled', false);
                    unselBtn.prop('disabled', false);
                } else {
                    icon.removeClass('fa-check-square-o').addClass('fa-square-o');
                    map.removeLayer(geoJsonLayers[targetLayer]);
                    // disable select and unselect all buttons
                    selBtn.prop('disabled', true);
                    unselBtn.prop('disabled', true);  
                }

            });
            
            // Select all polygons from a Proposal, regardless of current state
            $('.layer-select-all').on('click', function () {
                loading(true);
                var targetLayer = $(this).parent().attr('for');
                setTimeout(function() {
                    geoJsonLayers[targetLayer].eachLayer(function(f){
                        var id = f.feature.properties.concat_id;
                        // Only add features that are not already selected
                        if (! (selectedSet.hasOwnProperty(id)) ){
                            selected(f); 
                        }                      
                    });
                    loading(false);
                }, 1);
            });
            
            
            // Remove all polygons from a Proposal
            $('.layer-unselect-all').on('click', function () {
                var $parent = $(this).parent();
                var targetLayer = $parent.attr('for');
                loading(true);
                setTimeout(function() {
                    geoJsonLayers[targetLayer].eachLayer(function(f){
                        unselected(f);                     
                    });
                    $parent.find('.layer-counter-current').html(0); // hard set the current layer counter to 0
                    loading(false);
                }, 1);
            });
            

            $('#panel-tabs button').on('click', function () {
                
                // Updates when one of the tabs on the left panel is clicked
                var elem = $(this); // the button that was clicked
                var id = $(this).val(); // the button value  = the id of for the panel content
                // Change clicked item to selected
                elem.addClass('selected');
                // Unselect other buttons
                elem.siblings().removeClass('selected');
                // Hide content from unselected tabs
                elem.siblings().each(function () {
                        var sib_id = $(this).val()
                        $('#'.concat(sib_id)).hide();
                    })
                    // Show content from selected tab
                $('#'.concat(id)).show();
            });
            
            
            // constructs the polygon search suggestion engine
            var sites = new Bloodhound({
              datumTokenizer: Bloodhound.tokenizers.whitespace,
              queryTokenizer: Bloodhound.tokenizers.whitespace,
              // array of EFH polygon names
              local: poly_names
            });

            $('#poly-search .typeahead').typeahead({
              hint: true,
              highlight: true,
              minLength: 1
            },
            {
              name: 'efhpoly',
              source: sites,
              limit: 10
            });
            
            // Return the selected value from the polygon search box
            
            $('#poly-search .typeahead').bind('typeahead:select', function(ev, suggestion) {
                zoom2Name(suggestion);
            });
            
            
        }  // end buildUI{}
        
        // Zoom to a polygon by name
        function zoom2Name(sitename) {
            map.fitBounds(poly_bounds[sitename])
        }

        // Convert sq meters to square miles and format nicely
        function sqm2sqmi(val) {
            var sqmi = val / 2589988.11
            if (sqmi >= 0.5 || sqmi == 0 ) {
                return (val / 2589988.11).toLocaleString(undefined, {
                    maximumFractionDigits: 0
                })
            } else {
                return "<1"
            }
        }

        // Convert meters to miles and format nicely
        function m2mi(val) {
            return (val / 1609.344).toLocaleString(undefined, {
                maximumFractionDigits: 0
            })
        }

        // Calculate percentage or return zero if denominator is zero
        function pct(num, denom) {
            if (denom == 0 || !(num) || num == 0) {
                return "0%";
            } else if ( (num / denom) < 0.01 ) {
                return "<1%";
            } else {
                return (num / denom).toLocaleString(undefined, {
                    style: 'percent'
                });
            }
        }
        
        // Format proportion as percent
        function prop2pct(val){
            return val.toLocaleString(undefined, {
                style: 'percent'
            });
        }
        
        // Round and Format to specified number of decimals
        function rnd(val, digits){
            return val.toLocaleString(undefined, {
                maximumFractionDigits: digits,
                minimumFractionDigits: digits,
            })
        }
        
        // Round to even thousands of dollars
        function dollars(val){
            return val.toLocaleString(undefined, {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0
            }) + "K"
        }

        function buildSummary() {

            // Remove starter text
            $('.start-text').hide();
            
            // Header for Polygon count
            $('#poly-count').text("(0)");

            // shortcut to our table element
            var $table = $('#summary-metrics'),
                rows = '';

            // Create empty table structure
            rows += '<tr class="table-row-header"><th>Environmental Metrics</th>' + '<th>Close</th>' + '<th>Open</th>' + '<th>Net</th></tr>' +
                '<tr><td>Area (sq mi)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><th>Substrate Type</th>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Hard</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Mixed</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Soft</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Unknown</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><th>Priority Habitats</th>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Hard Substrate</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Canyons & Gullies</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Seamounts</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Corals & Sponges (1 km blocks)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>OFS 20% HSP (sq mi) </td>' + '<td></td>' + '<td></td>' + '<td></td></tr>';
//                '<tr class="table-row-header"><th>Socioeconomic Metrics</th>' + '<th>Displace</th>' + '<th>Restore</th>' + '<th>Net</th></tr>' +
//                '<tr><th>Trawl Effort</th>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
//                '<tr><td>Total Tow Length (mi)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
//                '<tr><td>Percent of Coastwide Tow Length</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
//                '<tr><th>Total Catch (Metric Tons)</th>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
//                '<tr><td>Flatfish (MT)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
//                '<tr><td>Rockfish (MT)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
//                '<tr><td>Roundfish (MT)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
//                '<tr><td>Sharks & Skates (MT)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
//                '<tr><td>Other (MT)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
//                '<tr><th>Total Ex-Vessel Value (Thousands of $)</th>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
//                '<tr><td>Flatfish ($1K)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
//                '<tr><td>Rockfish ($1K)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
//                '<tr><td>Roundfish ($1K)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
//                '<tr><td>Sharks & Skates ($1K)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
//                '<tr><td>Other ($1K)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>';
                    
            // update the html of the table
            $table.html(rows);

        }

        function updateSummmary() {
            // use selectedSet to summarize Data

            // List of metric attributes
            var metric_attributes = [
                "SiteAreaM2",
                "hard",
                "mixed",
                "soft",
                "unknown",
                "CynAreaM2",
                "SmtAreaM2",
                "corspg_cnt",
                "OF20AreaM2",
//                "TowLenM",
//                "PropLenTot",
//                "Total_MT",
//                "Flatfish_MT",
//                "Rockfish_MT",
//                "Roundfish_MT",
//                "SharkSkate_MT",
//                "Other_MT",
//                "Total_Rev",
//                "Flatfish_Rev",
//                "Rockfish_Rev",
//                "Roundfish_Rev",
//                "SharkSkate_Rev",
//                "Other_Rev",               
            ]


            var polyData = []; // individual polygon attributes

            // Initialize Summary Data objects with zeros for all metrics
            var summOpen = {
                SiteAreaM2: 0,
                hard: 0,
                mixed: 0,
                soft: 0,
                unknown: 0,
                CynAreaM2: 0,
                SmtAreaM2: 0,
                corspg_cnt: 0,
                OF20AreaM2: 0,
//                TowLenM: 0,
//                PropLenTot: 0,
//                Total_MT: 0,
//                Flatfish_MT: 0,
//                Rockfish_MT: 0,
//                Roundfish_MT: 0,
//                SharkSkate_MT: 0,
//                Other_MT: 0,
//                Total_Rev: 0,
//                Flatfish_Rev: 0,
//                Rockfish_Rev: 0,
//                Roundfish_Rev: 0,
//                SharkSkate_Rev: 0,
//                Other_Rev: 0    
            };
            var summClose = {
                SiteAreaM2: 0,
                hard: 0,
                mixed: 0,
                soft: 0,
                unknown: 0,
                CynAreaM2: 0,
                SmtAreaM2: 0,
                corspg_cnt: 0,
                OF20AreaM2: 0,
//                TowLenM: 0,
//                PropLenTot: 0,
//                Total_MT: 0,
//                Flatfish_MT: 0,
//                Rockfish_MT: 0,
//                Roundfish_MT: 0,
//                SharkSkate_MT: 0,
//                Other_MT: 0,
//                Total_Rev: 0,
//                Flatfish_Rev: 0,
//                Rockfish_Rev: 0,
//                Roundfish_Rev: 0,
//                SharkSkate_Rev: 0,
//                Other_Rev: 0    
            };

            // loop through all the selected features
            for ( var i in selectedSet ){
                
                var selection = selectedSet[i];
                var props = selection.feature.properties;

                // Add individual polygon metrics to polyData list
                polyData.push(props);

                // loop through the properties
                for (var att in props) {

                    // Only use metrics of interest
                    if (metric_attributes.indexOf(att) >= 0) {
                        // if it's a number
                        if (Number(props[att])) {

                            // Areas to be closed
                            if (props.RegAction === "close") {
                                summClose[att] += props[att];
                            } else { // areas to be reopened
                                summOpen[att] += props[att];
                            }
                        }
                    }
                }
                

            } // end of loop through selectedSet
            
            
            // Update area count text
            var polyCount = Object.keys(selectedSet).length;

            // Activate or de-activate zoom and clear buttons depending on presence of selection
            if (polyCount == 0) {
                $('#zoom').removeClass('available');
                $('#clear').removeClass('available');
            } else {
                $('#zoom').addClass('available');
                $('#clear').addClass('available');
            }


            if (polyCount == 1) {
                $('#poly-count').text("(" + polyCount + ")")
            } else {
                $('#poly-count').text("(" + polyCount + ")")
            }

            // Remove starter text
            $('.start-text').hide();
            
            // shortcut to our table element
            var $table = $('#summary-metrics'),
                rows = '';

            // Variables for frequently used metrics
            var areaClose = summClose.SiteAreaM2;
            var areaOpen = summOpen.SiteAreaM2;
            var areaNet = areaClose - areaOpen;

            // Populate the table
            rows += '<tr class="table-row-header"><th>Environmental Metrics</th>' + '<th>Close</th>' + '<th>Open</th>' + '<th>Net</th></tr>' +
                '<tr><td>Area (sq mi)</td>' + '<td>' + sqm2sqmi(areaClose) + '</td>' +
                '<td>' + sqm2sqmi(areaOpen) + '</td>' +
                '<td>' + sqm2sqmi(areaNet) + '</td></tr>' +
                '<tr><th>Substrate Type</th><td></td><td></td><td></td></tr>' +
                '<tr><td>Hard (sq mi) </td>' + '<td>' + sqm2sqmi(summClose.hard) + '</td>' +
                '<td>' + sqm2sqmi(summOpen.hard) + '</td>' +
                '<td>' + sqm2sqmi(calcNet(summClose.hard, summOpen.hard)) + '</td></tr>' +
                '<tr><td>Mixed (sq mi) </td>' + '<td>' + sqm2sqmi(summClose.mixed) + '</td>' +
                '<td>' + sqm2sqmi(summOpen.mixed) + '</td>' +
                '<td>' + sqm2sqmi(calcNet(summClose.mixed, summOpen.mixed)) + '</td></tr>' +
                '<tr><td>Soft (sq mi) </td>' + '<td>' + sqm2sqmi(summClose.soft) + '</td>' +
                '<td>' + sqm2sqmi(summOpen.soft, areaOpen) + '</td>' +
                '<td>' + sqm2sqmi(calcNet(summClose.soft, summOpen.soft), areaNet) + '</td></tr>' +
                '<tr><td>Unknown (sq mi) </td>' + '<td>' + sqm2sqmi(summClose.unknown) + '</td>' +
                '<td>' + sqm2sqmi(summOpen.unknown, areaOpen) + '</td>' +
                '<td>' + sqm2sqmi(calcNet(summClose.unknown, summOpen.unknown), areaNet) + '</td></tr>' +
                '<tr><th>Priority Habitats</th><td></td><td></td><td></td></tr>' +
                '<tr><td>Hard Substrate (sq mi) </td>' + '<td>' + sqm2sqmi(summClose.hard) + '</td>' +
                '<td>' + sqm2sqmi(summOpen.hard, areaOpen) + '</td>' +
                '<td>' + sqm2sqmi(calcNet(summClose.hard, summOpen.hard), areaNet) + '</td></tr>' +
                '<tr><td>Canyons & Gullies  (sq mi) </td>' + '<td>' + sqm2sqmi(summClose.CynAreaM2) + '</td>' +
                '<td>' + sqm2sqmi(summOpen.CynAreaM2, areaOpen) + '</td>' +
                '<td>' + sqm2sqmi(calcNet(summClose.CynAreaM2, summOpen.CynAreaM2), areaNet) + '</td></tr>' +
                '<tr><td>Seamounts  (sq mi) </td>' + '<td>' + sqm2sqmi(summClose.SmtAreaM2) + '</td>' +
                '<td>' + sqm2sqmi(summOpen.SmtAreaM2, areaOpen) + '</td>' +
                '<td>' + sqm2sqmi(calcNet(summClose.SmtAreaM2, summOpen.SmtAreaM2), areaNet) + '</td></tr>' +
                '<tr><td>Corals & Sponges (1 km blocks)</td>' + '<td>' + summClose.corspg_cnt + '</td>' +
                '<td>' + summOpen.corspg_cnt + '</td>' +
                '<td>' + calcNet(summClose.corspg_cnt, summOpen.corspg_cnt) + '</td></tr>' +
                '<tr><td>OFS 20% HSP (sq mi) </td>' + '<td>' + sqm2sqmi(summClose.OF20AreaM2) + '</td>' +
                '<td>' + sqm2sqmi(summOpen.OF20AreaM2, areaOpen) + '</td>' +
                '<td>' + sqm2sqmi(calcNet(summClose.OF20AreaM2, summOpen.OF20AreaM2), areaNet) + '</td></tr>';
//                '<tr class="table-row-header"><th>Socioeconomic Metrics</th><th>Displace</th><th>Restore</th><th>Net</th></tr>' +
//                '<tr><th>Trawl Effort</th>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
//                '<tr><td>Total Tow Length (mi)</td>' + '<td>' + m2mi(summClose.TowLenM) + '</td>' +
//                '<td>' + m2mi(summOpen.TowLenM) + '</td>' +
//                '<td>' + m2mi(calcNet( summOpen.TowLenM, summClose.TowLenM)) + '</td></tr>' +   
//                '<tr><td>Percent of Coastwide Tow Length</td>' + '<td>' + prop2pct(summClose.PropLenTot) + '</td>' +
//                '<td>' + prop2pct(summOpen.PropLenTot) + '</td>' +
//                '<td>' + prop2pct(calcNet(summOpen.PropLenTot, summClose.PropLenTot)) + '</td></tr>' + 
//                '<tr><th>Total Catch (Metric Tons)</th>' + '<td>' + rnd(summClose.Total_MT, 1) + '</td>' + 
//                '<td>' + rnd(summOpen.Total_MT, 1) + '</td>' + 
//                '<td>' + rnd(calcNet(summClose.Total_MT,summOpen.Total_MT), 1) + '</td></tr>' +
//                '<tr><td>Flatfish (MT)</td>' + '<td>' + rnd(summClose.Flatfish_MT, 1) + '</td>' + 
//                '<td>' + rnd(summOpen.Flatfish_MT, 1) + '</td>' + 
//                '<td>' + rnd(calcNet(summClose.Flatfish_MT,summOpen.Flatfish_MT), 1) + '</td></tr>' +
//                '<tr><td>Rockfish (MT)</td>'  + '<td>' + rnd(summClose.Rockfish_MT, 1) + '</td>' + 
//                '<td>' + rnd(summOpen.Rockfish_MT, 1) + '</td>' + 
//                '<td>' + rnd(calcNet(summClose.Rockfish_MT,summOpen.Rockfish_MT), 1) + '</td></tr>' +
//                '<tr><td>Roundfish (MT)</td>'  + '<td>' + rnd(summClose.Roundfish_MT, 1) + '</td>' + 
//                '<td>' + rnd(summOpen.Roundfish_MT, 1) + '</td>' + 
//                '<td>' + rnd(calcNet(summClose.Roundfish_MT,summOpen.Roundfish_MT), 1) + '</td></tr>' +
//                '<tr><td>Sharks & Skates (MT)</td>'  + '<td>' + rnd(summClose.SharkSkate_MT, 1) + '</td>' + 
//                '<td>' + rnd(summOpen.SharkSkate_MT, 1) + '</td>' + 
//                '<td>' + rnd(calcNet(summClose.SharkSkate_MT,summOpen.SharkSkate_MT), 1) + '</td></tr>' +
//                '<tr><td>Other (MT)</td>' + '<td>' + rnd(summClose.Other_MT, 1) + '</td>' + 
//                '<td>' + rnd(summOpen.Other_MT, 1) + '</td>' + 
//                '<td>' + rnd(calcNet(summClose.Other_MT,summOpen.Other_MT), 1) + '</td></tr>' +
//                '<tr><th>Total Ex-Vessel Value (Thousands of $)</th>' + '<td>' + dollars(summClose.Total_Rev) + '</td>' + 
//                '<td>' + dollars(summOpen.Total_Rev) + '</td>' + 
//                '<td>' + dollars(calcNet(summClose.Total_Rev,summOpen.Total_Rev)) + '</td></tr>' +
//                '<tr><td>Flatfish ($1K)</td>' + '<td>' + dollars(summClose.Flatfish_Rev) + '</td>' + 
//                '<td>' + dollars(summOpen.Flatfish_Rev) + '</td>' + 
//                '<td>' + dollars(calcNet(summClose.Flatfish_Rev,summOpen.Flatfish_Rev)) + '</td></tr>' +
//                '<tr><td>Rockfish ($1K)</td>'  + '<td>' + dollars(summClose.Rockfish_Rev) + '</td>' + 
//                '<td>' + dollars(summOpen.Rockfish_Rev) + '</td>' + 
//                '<td>' + dollars(calcNet(summClose.Rockfish_Rev,summOpen.Rockfish_Rev)) + '</td></tr>' +
//                '<tr><td>Roundfish ($1K)</td>'  + '<td>' + dollars(summClose.Roundfish_Rev) + '</td>' + 
//                '<td>' + dollars(summOpen.Roundfish_Rev) + '</td>' + 
//                '<td>' + dollars(calcNet(summClose.Roundfish_Rev,summOpen.Roundfish_Rev)) + '</td></tr>' +
//                '<tr><td>Sharks & Skates ($1K)</td>'  + '<td>' + dollars(summClose.SharkSkate_Rev) + '</td>' + 
//                '<td>' + dollars(summOpen.SharkSkate_Rev) + '</td>' + 
//                '<td>' + dollars(calcNet(summClose.SharkSkate_Rev,summOpen.SharkSkate_Rev)) + '</td></tr>' +
//                '<tr><td>Other ($1K)</td>' + '<td>' + dollars(summClose.Other_Rev) + '</td>' + 
//                '<td>' + dollars(summOpen.Other_Rev) + '</td>' + 
//                '<td>' + dollars(calcNet(summClose.Other_Rev,summOpen.Other_Rev)) + '</td></tr>';
            
            // update the html of the table
            $table.html(rows);

            // update individual poly table with the selected set
            updatePolyTable();


        } // end updatedSummary()

        function calcNet(close, open) {

            // Calculate Net value from summary data values
            // Most values are just difference, but some, like Coral/Sponge block count will need additional logic
            return close - open;

        } // end calcNet

        function buildPolyTable() {
            // shortcut to our table element
            var $table = $('#polygon-metrics'),
                rows = '';

            // empty table structure
            rows += '<tr>' +
                '<th>Action</th>' +
                '<th>Site Name</th>' +
                '<th>Alternative</th>' +
                '<th>Area (sq mi)</th>' +
                '<th>Hard (sq mi)</th>' +
                '<th>Mixed (sq mi)</th>' +
                '<th>Soft (sq mi)</th>' +
                '<th>Unknown (sq mi)</th>' +
                '<th>Canyons & Gullies (sq mi)</th>' +
                '<th>Seamounts (sq mi)</th>' +
                '<th>Corals & Sponges (1 km blocks)</th>' +
                '<th>OFS 20% HSP (sq mi)</th>' +
//                '<th>Trawl Tow Length (mi)</th>' +
//                '<th>Percent Coastwide Tow Length</th>' +
//                '<th>Total Catch (MT)</th>' +
//                '<th>Flatfish Catch (MT)</th>' +
//                '<th>Rockfish Catch (MT)</th>' +
//                '<th>Roundfish Catch (MT)</th>' +
//                '<th>Sharks & Skates Catch (MT)</th>' +
//                '<th>Other Catch (MT)</th>' +
//                '<th>Total Ex-Vessel Value</th>' +
//                '<th>Flatfish Ex-Vessel Value</th>' +
//                '<th>Rockfish Ex-Vessel Value</th>' +
//                '<th>Roundfish Ex-Vessel Value</th>' +
//                '<th>Sharks & Skates Ex-Vessel Value</th>' +
//                '<th>Other Catch Ex-Vessel Value</th>' +                
                '</tr>'

            // update the html of the table
            $table.html(rows);
            
            //  Hide the csv download button
            $('#download-csv').removeClass('show');

        }

        function updatePolyTable() {
            // Build content of Poly Table with selectedSet

            var $table = $('#polygon-metrics'),
                rows = '';

            // Table Headers
           rows += '<tr>' +
                '<th>Action</th>' +
                '<th>Site Name</th>' +
                '<th>Alternative</th>' +
                '<th>Area (sq mi)</th>' +
                '<th>Hard (sq mi)</th>' +
                '<th>Mixed (sq mi)</th>' +
                '<th>Soft (sq mi)</th>' +
                '<th>Unknown (sq mi)</th>' +
                '<th>Canyons & Gullies (sq mi)</th>' +
                '<th>Seamounts (sq mi)</th>' +
                '<th>Corals & Sponges (1 km blocks)</th>' +
                '<th>OFS 20% HSP (sq mi)</th>' +
                '<th>Conservation Value Mean</th>' +
                '<th>Conservation Value Variance</th>' +
//                '<th>Trawl Tow Length (mi)</th>' +                
//                '<th>Percent Coastwide Tow Length</th>' +
//                '<th>Total Catch (MT)</th>' +
//                '<th>Flatfish Catch (MT)</th>' +
//                '<th>Rockfish Catch (MT)</th>' +
//                '<th>Roundfish Catch (MT)</th>' +
//                '<th>Sharks & Skates Catch (MT)</th>' +
//                '<th>Other Catch (MT)</th>' +
//                '<th>Total Ex-Vessel Value</th>' +
//                '<th>Flatfish Ex-Vessel Value</th>' +
//                '<th>Rockfish Ex-Vessel Value</th>' +
//                '<th>Roundfish Ex-Vessel Value</th>' +
//                '<th>Sharks & Skates Ex-Vessel Value</th>' +
//                '<th>Other Catch Ex-Vessel Value</th>' + 
               '</tr>'

            // loop through all the selected features                
            for ( var i in selectedSet ){
                
                var selection = selectedSet[i];
                var data = selection.feature.properties;

                // Tow Length filter (< 3 vessels in an area)
                var towLen;
                if (data.VesCount >= 3 || data.VesCount == 0) {
                    towLen = m2mi(data.TowLenM);
                    
                } else {
                    towLen = "**";
                }


                rows += '<tr>' +
                    '<td>' + data.RegAction + '</td>' +
                    '<td>' + data.SiteName + '</td>' +
                    '<td>' + data.Alternative + '</td>' +
                    '<td>' + sqm2sqmi(data.SiteAreaM2) + '</td>' +
                    '<td>' + sqm2sqmi(data.hard) + '</td>' +
                    '<td>' + sqm2sqmi(data.mixed) + '</td>' +
                    '<td>' + sqm2sqmi(data.soft) + '</td>' +
                    '<td>' + sqm2sqmi(data.unknown) + '</td>' +
                    '<td>' + sqm2sqmi(data.CynAreaM2) + '</td>' +
                    '<td>' + sqm2sqmi(data.SmtAreaM2) + '</td>' +
                    '<td>' + data.corspg_cnt + '</td>' +
                    '<td>' + sqm2sqmi(data.OF20AreaM2) + '</td>' +              
                    '<td>' + rnd(data.cv_mean, 2) + '</td>' +
                    '<td>' + rnd(data.cv_var, 2) + '</td>'
 
                // Remove all socioeconomic data for now

//                if (data.VesCount >= 3 || data.VesCount == 0) {
//                    rows += '<td>' + m2mi(data.TowLenM) + '</td>' +
//                    '<td>' + prop2pct(data.PropLenTot) + '</td>' +
//                    '<td>' + rnd(data.Total_MT, 1) + '</td>' +
//                    '<td>' + rnd(data.Flatfish_MT, 1) + '</td>' +
//                    '<td>' + rnd(data.Rockfish_MT, 1) + '</td>' +
//                    '<td>' + rnd(data.Roundfish_MT, 1) + '</td>' +
//                    '<td>' + rnd(data.SharkSkate_MT, 1) + '</td>' +
//                    '<td>' + rnd(data.Other_MT, 1) + '</td>' +
//                    '<td>' + dollars(data.Total_Rev) + '</td>' +
//                    '<td>' + dollars(data.Flatfish_Rev) + '</td>' +
//                    '<td>' + dollars(data.Rockfish_Rev) + '</td>' +
//                    '<td>' + dollars(data.Roundfish_Rev) + '</td>' +
//                    '<td>' + dollars(data.SharkSkate_Rev) + '</td>' +
//                    '<td>' + dollars(data.Other_Rev) + '</td>'
//                } else {
//                    rows += '<td>' + '**' + '</td>' +
//                    '<td>' + '**' + '</td>' +
//                    '<td>' + '**' + '</td>' +
//                    '<td>' + '**' + '</td>' +
//                    '<td>' + '**' + '</td>' +
//                    '<td>' + '**' + '</td>' +
//                    '<td>' + '**' + '</td>' +
//                    '<td>' + '**' + '</td>' +
//                    '<td>' + '**' + '</td>' +
//                    '<td>' + '**' + '</td>' +
//                    '<td>' + '**' + '</td>' +
//                    '<td>' + '**' + '</td>' +
//                    '<td>' + '**' + '</td>' +
//                    '<td>' + '**' + '</td>'
//               }
                               
                rows += '</tr>'
//            });
            } // end of loop through selectedSet

            // update the html of the table
            $table.html(rows);
            
            $('#download-csv').addClass('show');
//            $('#download-csv').css('visibility','visible');


        } // end of updatePolyTable()

        // adds or removes a loader icon at the top-right of the page
        function loading(boolean) {
            if (boolean) $('html').addClass('loading');
            else $('html').removeClass('loading');
        }

        (function () {

            $("#download-csv").click(function () {
                $('#polygon-metrics').tableToCSV();
            });

        })();
        
    </script>

</body>

</html>