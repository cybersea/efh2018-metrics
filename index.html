<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <title>EFH Metrics - EIS 2018</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link rel="shortcut icon" href="images/sgfish_icon.png" type="image/png" />
    
    <!--Remote -->
    <!--
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet/v1.3.1/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@3.5.1/turf.min.js"></script>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v1.3.1/leaflet.css" />
    <script src="https://unpkg.com/esri-leaflet@2.1.2/dist/esri-leaflet.js"></script>
    -->

    <!--Local -->  
    <link href='css/normalize.css' rel="stylesheet">
    <link href="css/leaflet.css" rel="stylesheet"/>
    <link href="css/easy-button.css" rel="stylesheet"/>
    
    <script src="js/jquery-1.11.2.min.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/esri-leaflet.js"></script>    
    <script src="js/turf.min.js"></script>
    <script src="js/jquery.tabletoCSV.js"></script>
    <script src="js/easy-button.js"></script>
    <script src="js/typeahead.bundle.min.js"></script>

    <!--Measure Tool -->      
    <!-- Remote
    <link rel="stylesheet" href="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.css" />
    <script src="https://ppete2.github.io/Leaflet.PolylineMeasure/Leaflet.PolylineMeasure.js"></script>
    -->
    <!--Local --> 
    <link href="css/Leaflet.PolylineMeasure.css" rel="stylesheet"/>
    <script src="js/Leaflet.PolylineMeasure.js"></script>
    
    <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Work+Sans:400,500,600' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
<!--    <script src="https://use.fontawesome.com/dbb89f5a68.js"></script>-->
    <link rel="stylesheet" href="fonts/font-awesome-4.6.3/css/font-awesome.min.css">

    <!-- custom css -->
    <link href="css/site.css" rel="stylesheet">

</head>

<body>
    
    <div id='map'></div>
    
    <div id='layer-control-text'></div>

    <div id="right-panel">
        
        <!-- HTML form for user to select EFH proposal to draw on map -->
        <!-- Note that values for data-nice-name must correspond exactly to attribute names in source GeoJSON data file -->
        <!-- Only Collaborative and Oceana proposals initially visible -->
        <!--        <h2>EFH Proposals</h2>-->

        <div id='poly-search'>
            <i class="fa fa-search"></i>
            <input class="typeahead" type="text" placeholder="Search by polygon name ...">
        </div>
        

        <div id="layer-controls" class="efhalts">
            <!-- Current EFH Alternatives.  Can be selected for metrics summaries and interacted with by polygon -->
            <p class="efh-type">EFHCA Alternatives</p>
            <!-- Collaborative -->
            <input id="collabLayer" type="checkbox" value="collabLayer" checked>
            <label for="collabLayer" style='color:#E5571D' data-nice-name="Collaborative">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-check-square-o layer-selection-icon"></i></span> 
                1a. Collaborative <span class="layer-counter"><span class="layer-counter-current">0</span>/59</span>
                <button class="layer-unselect-all tooltip" data-tooltip="Remove Proposal from Selection">
                    <i class="fa fa-minus"></i>
                </button>
                <button class="layer-select-all tooltip" data-tooltip="Add Proposal to Selection">
                    <i class="fa fa-plus"></i>
                </button>
            </label>
            <!-- Oceana -->
            <input id="onoLayer" type="checkbox" value="onoLayer" checked>
            <label for="onoLayer" style='color:#6F067B' data-nice-name="Oceana et al.">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-check-square-o layer-selection-icon"></i></span> 
                1b. Oceana et al. <span class="layer-counter"><span class="layer-counter-current">0</span>/68</span>
                <button class="layer-unselect-all tooltip" data-tooltip="Remove Proposal from Selection">
                    <i class="fa fa-minus"></i>
                </button>
                <button class="layer-select-all tooltip" data-tooltip="Add Proposal to Selection">
                    <i class="fa fa-plus"></i>
                </button>
            </label>
            <!-- EFHCA Preferred Alternative -->
            <input id="paLayer" type="checkbox" value="paLayer" checked>
            <label for="paLayer" style='color:#0F6001' data-nice-name="PFMC FPA">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-check-square-o layer-selection-icon"></i></span> 
                1h. Preferred <span class="layer-counter"><span class="layer-counter-current">0</span>/70</span>
                <button class="layer-unselect-all tooltip" data-tooltip="Remove Proposal from Selection">
                    <i class="fa fa-minus"></i>
                </button>
                <button class="layer-select-all tooltip" data-tooltip="Add Proposal to Selection">
                    <i class="fa fa-plus"></i>
                </button>
            </label>
         </div>
        
         <div id='ui-controls'>
            <button value="Zoom" class="layer-ui-button" id="zoom">Zoom to selection <i class="fa fa-arrows-alt"></i></button>
            <button value="Clear" class="layer-ui-button" id="clear">Clear selection <i class="fa fa-ban"></i></button>
        </div>
        
        <div id="layer-controls" class="rcaalts">            
            <!-- RCA Alternatives  Can only by turned on or off to draw on map -->
            <p class="efh-type">Trawl RCA Alternatives</p>
            <!-- Remove Trawl RCA -->
            <input id="removercaLayer" type="checkbox" value="removercaLayer" unchecked>
            <label for="removercaLayer" style='color:#737300' data-nice-name="Remove RCA">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-square-o layer-selection-icon"></i></span> 
                2c. Remove Trawl RCA
            </label> 
            <!-- Block Area Closures -->
            <input id="bacLayer" type="checkbox" value="bacLayer" unchecked>
            <label for="bacLayer" style='color:#2e9e82' data-nice-name="Block Area Closures">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-square-o layer-selection-icon"></i></span> 
                2c. Block Area Closures
            </label>
            <!-- Remove Trawl RCA (OR/CA), Preferred Alt -->
            <input id="removercaORCALayer" type="checkbox" value="removercaORCALayer" unchecked>
            <label for="removercaORCALayer" style='color:#737300' data-nice-name="Remove RCA (OR/CA)">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-square-o layer-selection-icon"></i></span> 
                2d. Preferred - Remove Trawl RCA (OR/CA)
            </label> 
            <!-- Block Area Closures (OR/CA) Preferred Alt -->
            <input id="bacORCALayer" type="checkbox" value="bacORCALayer" unchecked>
            <label for="bacORCALayer" style='color:#2e9e82' data-nice-name="PFMC FPA Trawl RCA">
                <span class="tooltip" data-tooltip="Toggle Visibility"><i class="fa fa-square-o layer-selection-icon"></i></span> 
                2d. Preferred - Block Area Closures (OR/CA)
            </label>
        </div> 
        
    </div>
    <!-- end right-panel -->
    
    <!-- Side panel Div   -->
    <div id='side-panel'>
        <h1>West Coast Groundfish<br> Essential Fish Habitat</h1>
        <h2 class='side-panel-header'>Alternatives Analysis Metrics</h2>
        <div id='panel-tabs'>
            <button class='selected' value='summary-panel'>Summary</button>
            <button value='polygons-panel'>Polygons <span id="poly-count">(0)</span></button>
            <button value='info-panel'>Info</button>
            <button value='help-panel'>How To</button>         
        </div>
        <div class='side-panel' id='summary-panel'>
            <!-- <h3 id='poly-count'></h3> -->
            <div class="table-wrapper"><table id="summary-metrics"></table></div>
            <span class='start-text'>
                <p>Click on an EFHCA polygon on the map to add or remove it from the selection.</p>
                <p style="text-align:center">OR</p>
                <p>Select all or unselect all polygons from an EFHCA alternative using the <i class="fa fa-plus"></i> or <i class="fa fa-minus"></i> icon next to its name.</p>
                <br>
                <p>A summary of metrics for all selected polygons will display here.</p>
                <p>To avoid double-counting in the summary metrics, if you select a polygon that overlaps a current selection, the overlapping polygon will be removed from the selection.</p>
                <br>
                <p>For the best experience, use the Chrome browser.  Other browsers have not been thoroughly tested.</p>
            </span>
        </div>
        <div class='side-panel' id='polygons-panel'>
            <div class="table-wrapper"><table id="polygon-metrics" class="data"></table></div>
            <button id='download-csv'>Download CSV File</button>
            <span class='start-text'>
                <p>Click on an EFHCA polygon on the map to add or remove it from the selection.</p>
                <p style="text-align:center">OR</p>
                <p>Select all or unselect all polygons from an EFHCA alternative using the <i class="fa fa-plus"></i> or <i class="fa fa-minus"></i> icon next to its name.</p>
                <br>
                <p>A table listing all the selected polygons and their metrics will display here.</p>
                <p>To avoid double-counting in the summary metrics, if you select a polygon that overlaps a current selection, the overlapping polygon will be removed from the selection.</p>
                <br>
                <p>For the best experience, use the Chrome browser.  Other browsers have not been thoroughly tested.</p>
            </span>
        </div>
        <div class='side-panel' id='info-panel'>
            <h2>Background</h2>
            <p>The <a href="http://www.pcouncil.org/" target="_blank">Pacific Fishery Management Council</a> (Council) is developing Amendment 28 to the <a href="https://www.pcouncil.org/groundfish/fishery-management-plan/" target="_blank"> Pacific Coast Groundfish Fishery Management Plan</a>. The Council and <a href="http://www.westcoast.fisheries.noaa.gov/" target="_blank"> NOAA National Marine Fisheries Service</a> (NMFS) are considering proposed changes to <a href="http://www.pcouncil.org/groundfish/groundfish-essential-fish-habitat/" target="_blank">Groundfish Essential Fish Habitat</a> Conservation Areas <a href="http://www.westcoast.fisheries.noaa.gov/fisheries/management/groundfish_closures/essential_fish.html" target="_blank">(EFHCA)</a> and the <a href="http://www.westcoast.fisheries.noaa.gov/fisheries/management/groundfish_closures/rockfish_areas.html" target="_blank">Trawl Rockfish Conservation Area</a> (RCA), as well as prohibiting the use of bottom-contact fishing gear in waters deeper than 3,500 meters off the West Coast of the United States.  The range of alternatives include areas to be closed to commercial trawl fishing, as well as currently closed areas to be reopened.</p>
        <p>Before identifying a preferred set of alternatives, the Council considered the impacts and benefits of the alternatives to groundfish habitat, biological resources, and socioeconomics related to fishing opportunities and coastal communities.</p>
        <p>The primary purpose of this tool is to support Council, stakeholder, and public review of the Draft Environmental Impact Statement. The user can select a custom set of polygons from any EFHCA Alternative and see a summary of the environmental metrics for their set. To provide context, associated data layers, such as existing trawl closures, jurisdictional boundaries, and Trawl RCA Alternatives can be displayed.</p>
        <p>The <a href="docs/EFH_RCA_Alternatives_DEIS_2018.pdf" target="_blank">EFHCA Alternatives</a> are:</p>
<!--            <ul style="list-style-type:none">-->
            <ul>
                <li>1.a.  Collaborative</li>
                <li>1.b.  Oceana et al. </li>
                <li>1.h.  EFHCA Preferred Alternative </li>
            </ul>
        
        <p>The <a href="docs/EFH_RCA_Alternatives_DEIS_2018.pdf" target="_blank">Trawl RCA Alternatives</a> are:</p>
            <ul>
                <li>2.c.  Remove the Trawl RCA and implement Block Area Closures (BAC) outside the tribal U&A fishing area</li>
                <li>2.d.  RCA Preferred Alternative -- Remove the Trawl RCA and implement Block Area Closures (BAC) in waters off Oregon and California </li>
            </ul>
        <p> <a href="docs/EFH_RCA_Alternatives_DEIS_2018.pdf" target="_blank">Alternative 3a</a> is to close waters deeper than 3,500 meters to bottom contact gear (display from Reference Layers)</p>           

        <h2>Credits</h2>
        <p>The Council, NOAA, National Marine Fisheries Service (NMFS), scientists, tribes, fishermen, and non-governmental organizations laid the analytical groundwork for this review through  a multi-year synthesis of new data sets and analyses.  Results of the Groundfish Essential Fish Habitat (EFH) Review are available through the <a href="http://efh-catalog.coas.oregonstate.edu/overview/" target="_blank">EFH Catalog</a> and the <a href="http://efh-viewer.coas.oregonstate.edu/efh/" target="_blank">EFH Viewer</a>. Additional layers and resources are available on the <a href="https://www.nwfsc.noaa.gov/data/map" target="_blank">NWFSC/FRAM Data Warehouse</a>.</p>
        <p>The EFH/RCA Project Team is producing a Draft Environmental Impact Statement <a href="http://www.pcouncil.org/groundfish/groundfish-essential-fish-habitat/" target="_blank">(PDEIS)</a> which is the basis for the metrics in this tool.</p>
        <p>Web Development by Allison Bailey, <a href="http://www.soundgis.com" target="_blank">Sound GIS</a></p>
        </div>

        <div class='side-panel' id='help-panel'>

        <h2>How to Use this Tool</h2>
        <p>This tool allows a user to select a custom set of EFHCA alternative polygons and see a summary of the metrics for their set. Associated data layers, such as existing trawl closures, jurisdictional boundaries, Trawl RCA Alternatives, other EFHCA proposals can be displayed to provide additional context.</p>
        <p>All Alternatives and Proposals:</p>
        <ul>
            <li>Hover over a polygon to view its metrics</li>
            <li>Toggle a checkbox in the right panel to draw or hide an alternative's or proposal's polygons on the map</li>
            <li>Zoom to a polygon by entering its name in the search box</li>
        </ul>
        <p>Reference Layers:</p>
        <ul>
            <li>Hover over the reference layers icon in the upper right of the map to select a layer's checkbox to draw it on the map</li>
        </ul>
        <p>EFHCA Alternatives only:</p>
        <ul>
            <li>Click an EFHCA polygon on the map to add or remove it from the selection</li>
            <li>Click the <i class="fa fa-plus"></i> icon next to an EFHCA alternative to select all of its polygons</li>
            <li>Click the <i class="fa fa-minus"></i> icon next to an EFHCA alternative to unselect all of its polygons</li> 
            <li>View the count of selected polygons out of the total polygons for each EFHCA alternative next to its name</li>
            <li>View summary metrics for all selected EFHCA polygons in the Summary Tab</li>
            <li>View and download a table of individual metrics for selected polygons in the Polygons Tab</li>
            <li>'**' indicate confidential economic data</li>
        </ul>
        <p>To avoid double-counting in the summary metrics, if you select a polygon that overlaps a current selection, the overlapped polygon will be removed from the selection.</p>
        <p>For the best experience, use the Chrome browser.  Other browsers have not been thoroughly tested.</p>
          
        </div>
        
    </div>

    <!--  GeoJSON EFH Alternatives source data (var proposals_metrics)   -->
    <script src="data/efh_proposals_metrics.js"></script>
    <!--  JSON with concat_id and list of unique 1km cells with corspg presence (var corspg1km_proposals)   -->
    <script src="data/corspg1km_proposals.js"></script>
    
    <!--  Main mapping script   -->
    <script>
        // instantiate the Leaflet map
        var options = {
            center: [41, -121.2],
            zoom: 6,
            dragging: true,
            zoomControl: true
        }
        var map = L.map('map', options);

        // Base Maps
        // ESRI Oceans Base Map
        var esri_ocean = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer/tile/{z}/{y}/{x}', {
            attribution: 'Tiles &copy; Esri &mdash; Sources: GEBCO, NOAA, CHS, OSU, UNH, CSUMB, National Geographic, DeLorme, NAVTEQ, and Esri',
            maxZoom: 12
        });
        // NOAA Nautical Charts - Tile Service
        var rnc_image = L.tileLayer('https://tileservice.charts.noaa.gov/tiles/50000_1/{z}/{x}/{y}.png', {
            attribution: 'NOAA Office of Coast Survey',
            maxZoom: 12
        });
        
        // Add base layers to map
        //  rnc_image.addTo(map); 
        esri_ocean.addTo(map);
        

        var baseLayers = {
            "ESRI Oceans": esri_ocean,
            "Nautical Charts": rnc_image
        };

        L.control.scale().addTo(map); // Add scale bar
        
        // Add home button - zooms to full extent when clicked
        var homeBtn = L.easyButton('fa-home', function(btn, map){
//            map.setView([41, -121.2]);
//            map.setZoom(6);
            map.setView([41, -121.2],6,{reset: true})
        }).addTo(map);
        
        var mt_options = {
            unit: 'nauticalmiles',
            showBearings: true,
            showUnitControl: true,
            measureControlLabel: '&#8614;', //  '&#128207;'
        };
        L.control.polylineMeasure(mt_options).addTo(map);
        
        // Create a geoJSON layer of all polygons for search function 
        var allpolys = L.geoJson(proposals_metrics);
        // Globals to store the polygon names and associate boundaries
        var poly_names = [];
        var poly_bounds = {};
        // Get the polygon names and associated boundaries
        allpolys.eachLayer(function(layer){
            poly_names.push(layer.feature.properties.SiteName);
            poly_bounds[layer.feature.properties.SiteName] =  layer.getBounds()
        });

        
        // Create Info Box for display of feature data on hover
        drawInfo();

        // Call function to create user interface for interacting with selected set
        buildUI();


        // Style info for individual proposal layers
        // proposer must match source data from GeoJson file
        var layerInfo = {
            collabLayer: {
                proposer: "Collaborative",
                color: "#E5571D",
                selectable: 1,
                draw:1,
            },
            onoLayer: {
                proposer: "Oceana et al.",
                color: "#6F067B",
                selectable: 1,
                 draw:1,
          },
             paLayer: {
                proposer: "PFMC FPA",
                color: "#0F6001",
                selectable: 1,
                 draw:1,
           },
            removercaLayer: {
                proposer: "Remove RCA",
                color: "#737300",
                selectable: 0,
                draw:0,
            },
            bacLayer: {
                proposer: "Block Area Closures",
                color: "#2e9e82",
                selectable: 0,
                draw:0,
            }, 
            removercaORCALayer: {
                proposer: "Remove RCA (OR/CA)",
                color: "#737300",
                selectable: 0,
                draw:0,
            },
            bacORCALayer: {
                proposer: "PFMC FPA Trawl RCA",
                color: "#2e9e82",
                selectable: 0,
                draw:0,
            }, 
        };
        
        var selectableAlts = [
            "Collaborative",
            "Oceana et al.",
            "PFMC FPA",
        ]
        
        var rcaAlts = [
            "Remove RCA",
            "Block Area Closures",
            "Remove RCA (OR/CA)",
            "PFMC FPA Trawl RCA",
        ]

        var geoJsonLayers = {}; // global to store all the geoJSON layers
        var selectedSet = {}; // global for selected features
        

        // Create individual geoJson Layers for each alternative
        for (var lyr in layerInfo) {
            
            var alternative = layerInfo[lyr].proposer; 

            geoJsonLayers[lyr] = L.geoJson(proposals_metrics, {
                filter: function (feature) {
                    if (feature.properties.Alternative == [layerInfo[lyr].proposer]) {
                        return feature;
                    }
                },
                style: function (feature) {
                    var opcty;
                    if (feature.properties.RegAction == "reopen")
                        opcty = 0.1;
                    else if (feature.properties.RegAction == "close")
                        opcty = 0.4;
                    styles = {
                        color: layerInfo[lyr].color,
                        fillColor: layerInfo[lyr].color,
                        fill: true,
                        weight: 2,
                        fillOpacity: opcty
                    }
                    return styles
                },
                onEachFeature: function (feature, layer) {
                    layer.on({
                        mouseover: highlightFeature,
                        mouseout: resetHighlight,
                        click: function(e){
                            if (selectableAlts.includes(feature.properties.Alternative)){
                                toggleSelected(e.target);
                            }
                        },
                    });
                }
            })//.addTo(map);

            geoJsonLayers[lyr].startStyle = styles
            geoJsonLayers[lyr].selectable = layerInfo[lyr].selectable

        } // end of loop through all geoJSON layers
        
//        // Add only Collaborative and Oceana layers to map to start
//        geoJsonLayers["onoLayer"].addTo(map);
//        geoJsonLayers["collabLayer"].addTo(map);
        
        // Add most EFH Alts to map to start  (if change, also need to update html for TOC)
        for (var lyr in geoJsonLayers) {
            if (layerInfo[lyr].draw){
                geoJsonLayers[lyr].addTo(map);
            }
        }
        
        // Supplemental Layer styles
        var depLineWeight = 2;
        var depOpacity = 1;
        
        var eezStyles = {
            fillColor: "#7f7f7f",
//            stroke: false,
            fillOpacity: 0.3,
            color: "black",
            weight: 1,
            opacity: 0.8            
        }        
        var eezLnStyles = {
            color: "#7f7f7f",
            weight: 1,
            opacity: 1
        }       
        var stateStyles = {
            color: "#7f7f7f",
            weight: 1,
            opacity: 1
        }
        var tribalUAStyles = {
            color: "#594600",
            weight: 2,
            opacity: 1
        } 
        var latStyles = {
            color: "black",
            weight: 1,
            opacity: depOpacity
        }      
        var dep30Styles = {
            color: "#87bede",
            weight: depLineWeight,
            opacity: depOpacity
        }       
        var dep100Styles = {
            color:"#348ccb",
            weight: depLineWeight,
            opacity: depOpacity
        }
        var dep150Styles = {
            color: "#08519c",
            weight: depLineWeight,
            opacity: depOpacity
        }        
        var dep700Styles = {
            color: "#000066",
            weight: depLineWeight,
            opacity: depOpacity
        }  
        var efhcaStyles = {
            fillColor: "#7f7f7f",
            fillOpacity: 0.3,
            color: "black",
            weight: 1,
            opacity: 1            
        }
        var efh700Styles = {
            fillColor: "#7f7f7f",
            fillOpacity: 0.3,
            color: "black",
            weight: 1,
            opacity: 1            
        }
        var ccaStyles = {
            fillColor: "#ffb366",
            fillOpacity: 0.3,
            color: "black",
            weight: 0.5,
            opacity: 1            
        }
        var cbgcaStyles = {
            fillColor: "#ff9999",
            fillOpacity: 0.3,
            color: "black",
            weight: 0.5,
            opacity: 1            
        }
        var rcaStyles = {
            fillColor: "#737300",
            fillOpacity: 0.3,
            color: "#343434",
            weight: 1,
            opacity: 1            
        }
        var gt3500Styles = {
            fillColor: "#002673",
            fillOpacity: 0.3,
            color: "#002673",
            weight: 1,
            opacity: 1            
        }
        
        sources = {
            //"eez": "data/eez_py.geojson",
            "eez_ln": "data/eez_ln.geojson",
            "state_ln": "data/state_ln.geojson",
            "tribalUA_ln": "data/tribalUA_ln.geojson",
            "lat": "data/strata_lat.geojson",
            "dep30fm": "data/rca_30fm.geojson",
            "dep100fm": "data/rca_100fm.geojson",
            "dep150fm": "data/rca_150fm.geojson",
            "dep700fm": "data/efh_700fm.geojson", 
            "efhca":"data/efh_consarea_py.geojson",
            "efh700":"data/efh_700fm_py.geojson",
            "cca":"data/cca_py.geojson",
            "cbgca":"data/cbgca_py.geojson",
            "rca":"data/RCA_TrawlGF_MarAprSepOct.geojson",
            "gt3500m":"data/deeperthan3500m_py.geojson",
        }
        
        styles = {
            //"eez": eezStyles,
            "eez_ln": eezLnStyles,
            "state_ln": stateStyles,
            "tribalUA_ln": tribalUAStyles,
            "lat": latStyles,
            "dep30fm": dep30Styles,
            "dep100fm": dep100Styles,
            "dep150fm": dep150Styles,
            "dep700fm": dep700Styles,
            "efhca":efhcaStyles,
            "efh700":efh700Styles,
            "cca":ccaStyles,
            "cbgca":cbgcaStyles,
            "rca":rcaStyles,
            "gt3500m":gt3500Styles,
        }
       
        var data = {}; // object to hold JSON data for each layer
        var layers = {}; // object to hold Leaflet GeoJSON layers
        
        // 
        $.when(
                $.getJSON(sources["eez_ln"], function(d) {
                    data["eez_ln"] =  d;
                }),
                $.getJSON(sources["state_ln"], function(d) {
                    data["state_ln"] =  d;
                }),
                  $.getJSON(sources["tribalUA_ln"], function(d) {
                    data["tribalUA_ln"] =  d;
                }),  
                $.getJSON(sources["lat"], function(d) {
                    data["lat"] =  d;
                }),
                 $.getJSON(sources["dep30fm"], function(d) {
                    data["dep30fm"] =  d;
                }),
                 $.getJSON(sources["dep100fm"], function(d) {
                    data["dep100fm"] =  d;
                }),
                 $.getJSON(sources["dep150fm"], function(d) {
                    data["dep150fm"] =  d;
                }),
                 $.getJSON(sources["dep700fm"], function(d) {
                    data["dep700fm"] =  d;
                }),
                $.getJSON(sources["efhca"], function(d) {
                    data["efhca"] =  d;
                }),  
                $.getJSON(sources["efh700"], function(d) {
                    data["efh700"] =  d;
                }),
                $.getJSON(sources["cca"], function(d) {
                    data["cca"] =  d;
                }),  
                $.getJSON(sources["cbgca"], function(d) {
                    data["cbgca"] =  d;
                }),  
                $.getJSON(sources["rca"], function(d) {
                    data["rca"] =  d;
                }),                 
                $.getJSON(sources["gt3500m"], function(d) {
                    data["gt3500m"] =  d;
                }),
        ).then(function() {

            // send complete data object to another function to create layers, etc.
            drawMap(data);
            
            // Draw legend with Leaflet GeoJSON layers
            drawSwitcher(layers);
            

        });
        

        // Use the GeoJSON input data to create Leaflet GeoJSON layers for map
        function drawMap(data){
            
            for (k in data){ // loop through each input source data layer
                    
                // Create Leaflet GeoJSON layer with source GeoJSON data
                var layer = L.geoJson(data[k], {
                    style: function (feature) {  // style for each GeoJSON feature
                        return styles[k]
                    },
                    onEachFeature: function (feature, layer) {
                        if (k === "lat") {
                            var label = feature.properties.Landmark.split(',')[0];
                            layer.bindTooltip(label, 
                                {permanent: true, direction: 'top', opacity: 1 , offset: [0,12]}
                                );
                        }
                    }
                });
                // Initial state of all layers is off. 
                // layer.addTo(map);
                
                layers[k] = layer;
                
            } // end loop for all source data layers
            
            // Add specific layers to draw on initial load here, if desired
            layers["tribalUA_ln"].addTo(map);
            
            // Make sure EFH and RCA polygons are always on bottom
            //  to avoid interference with Proposal selection and hover functions
            map.on('overlayadd', function(e){
                if (e.name.indexOf('EFH') >= 0 || e.name.indexOf('RCA') >= 0){
                    e.layer.bringToBack();
                } 
            });

                        
        } // end drawMap()
  
        
        function drawSwitcher(layers){
            
            // Layer Switcher   
            
            var layerLabels = {
                "<b style='color:#7f7f7f'>EEZ</b>": layers["eez_ln"],
                "<b style='color:#7f7f7f'>State Waters</b>": layers["state_ln"],
                "<b style='color:#594600'>Tribal U&A, 2106 </b><a style='color:#594600'  href='http://www.westcoast.fisheries.noaa.gov/publications/fishery_management/groundfish/public_notices/public_notice_tribal_u_a.pdf' target='_blank'>public notice</a>": layers["tribalUA_ln"],
                "<b style='color:black'>Latitude Breaks</b>": layers["lat"],
                "<b style='color:#87bede'>30 fathoms</b>": layers["dep30fm"],
                "<b style='color:#348ccb'>100 fathoms</b>": layers["dep100fm"],
                "<b style='color:#08519c'>150 fathoms</b>": layers["dep150fm"],
                "<b style='color:#000066'>700 fathoms</b>": layers["dep700fm"],
                "<b style='color:#7f7f7f'>EFH Conservation Areas</b>": layers["efhca"],
                "<b style='color:#7f7f7f'>EFH 700-fm Closure</b>": layers["efh700"],
                 "<b style='color:#ffb366'>Cowcod Conservation Area</b>": layers["cca"],
                "<b style='color:#ff9999'>Cordell Bank Groundfish Closed Area</b>": layers["cbgca"],
                "<b style='color:#737300'>Trawl RCA, 2015</b>": layers["rca"],
                "<b style='color:#002673'>Alt 3a: Waters Deeper than 3500 m</b>": layers["gt3500m"],
            }

            var switcher = L.control.layers(baseLayers, layerLabels, {
                collapsed: true});
            switcher.addTo(map); 
            
            // Add text label next to layer switcher control
            $( "#layer-control-text" ).html( "<p>Reference<br>Layers</p>" );
 
        } // end drawSwitcher()


        // Select or unselect feature depending on its current state
        function toggleSelected(layer){

            var id = layer.feature.properties.concat_id;
            
            if ( selectedSet.hasOwnProperty(id) ){ // in selected set
                
                // Unselect it
                unselected(layer);              
                
            } else { // If already in selected set

                // Select it
                selected(layer);

            }           
        } // end toggleSelected()
        
 
        // Runs when a feature is selected
        function selected(layer) {

            var data = layer.feature.properties;
            var id = layer.feature.properties.concat_id;
            var overlapping = [];

            // If it isn't already selected, add to set and change style
            //  otherwise, unselect it

            // Change Styles 
            layer.setStyle({
                color: "yellow",
            });
            layer.bringToFront();
            
            // Test if it overlaps any current selections
            for ( var i in selectedSet ){
                var feat2compare = selectedSet[i];
                if (isOverlapped(layer, feat2compare)) {
                    // if a current feature is overlapped by selection, add to list
                    overlapping.push(feat2compare);
                }
            }                

            // Add selected feature to the selected set - concat_id is object key
            selectedSet[id]= layer;

            // Add the feature's stats to the summary statistics
            updateSummmary();

            // Add the feature's metrics to the polygon table
            updatePolyTable(data);

            // increase layer control counter by 1 for this proposal
            var $layerCounter = $('label[data-nice-name*="'+data.Alternative+'"]').find('.layer-counter-current');
            var currentValue = +$layerCounter.html(); // the '+' turns it into a number
            $layerCounter.html(currentValue + 1);

            // Unselect any overlapping features
            overlapping.forEach(function (layer) {
                unselected(layer);
            });
            
        } // end selected()

        // Runs when a feature is removed from selection 
        function unselected(layer) {

            // var layer = e.target;
            var data = layer.feature.properties;
            var id = layer.feature.properties.concat_id;
            var proposer = layer.feature.properties.Alternative;

            // If it is selected, remove from selected set object and revert style   
            if (selectedSet.hasOwnProperty(id)){

                // Remove poly from selected set
                delete selectedSet[id];
                
                // Get original color of layer based on proposer
                for (lyr in layerInfo) {
                    if (proposer === layerInfo[lyr].proposer) {
                        var strokeColor = layerInfo[lyr].color
                    }
                }

                // Change color back to original 
                layer.setStyle({
                    color: strokeColor,
                });
                // Following causes errors if layer is not currently visible
                //  layer.bringToFront();
            }

            // decrease layer control counter by 1 for this proposal
            var $layerCounter = $('label[data-nice-name*="'+data.Alternative+'"]').find('.layer-counter-current');
            var currentValue = +$layerCounter.html(); // the '+' turns it into a number
            $layerCounter.html(currentValue - 1);

            // Remove the feature's stats from the summary statistics
            updateSummmary();

        } // end unselected()

        // Determine if two polygons overlap
        function isOverlapped(feature1, feature2) {

            // Input is two Leaflet layer polygons 
            // Convert polys GeoJSON
            var poly1 = feature1.toGeoJSON();
            var poly2 = feature2.toGeoJSON();

            // Turf Intersection function
            var intersection = turf.intersect(poly1, poly2);

            // Only want poly overlaps, not shared boundary intersections
            if (intersection) {
                if (intersection.geometry.type === "Polygon") {
                    return feature2;
                } else {
                    return false
                }
            } else {
                return false
            }

        } // end isOverlapped()

        // Create an array of Leaflet Bounds for each feature
        function getSelectedBounds() {

            var selectedBounds = [];
            
            // Get bounds for selected set of layers
            for ( var i in selectedSet ){
                selectedBounds.push(selectedSet[i].getBounds())
            }

            return selectedBounds;

        } // end getSelectedBounds()

        function zoomToSelected() {

            // Get the bounds of currently selected features
            var bounds = getSelectedBounds();

            // Zooms to currently selected polygons
            map.fitBounds(getSelectedBounds());

        } // end zoomToSelected()


        // Clear all selected polygons
        function clearSelected() {

            for ( var i in selectedSet ){

                var layer = selectedSet[i];
                var proposer = layer.feature.properties.Alternative;

                // Get original color of layer based on proposer
                for (lyr in layerInfo) {
                    if (proposer === layerInfo[lyr].proposer) {
                        var strokeColor = layerInfo[lyr].color
                    }
                }

                // Change color back to original 
                layer.setStyle({
                    color: strokeColor,
                });

                $('#zoom').removeClass('available');
                $('#clear').removeClass('available');
            }

            $('.layer-counter-current').html(0);
                        
            selectedSet = {};  // remove all layers from selected set

            buildSummary() // re-create empty summary table

            buildPolyTable() // re-create empty polygon table
        }

        // Runs on mouseover of a feature - updates style and grabs data for info box
        function highlightFeature(e) {

            var layer = e.target;

            // Change Styles to make outline wider
            layer.setStyle({
                weight: 5,
                dashArray: '',
            });

            if (!L.Browser.ie && !L.Browser.opera) {
                layer.bringToFront();
            }

            // Update the info box               
            updateInfo(layer)
            
            $(".poly-info").show(); // Show the info box

        } // end highlightFeature()

        // Runs when mouseout of feature - Returns feature style to original
        function resetHighlight(e) {

            // Function that when mouseout of feature
            var layer = e.target;

            layer.setStyle({
                weight: 2
            })

            $(".poly-info").hide(); // Hide the info box

        } // end resetHighlight()

        function drawInfo() {

            // create a new Leaflet control object, and position it lower right
            var info = L.control({
                position: 'bottomright'
            });
            info.onAdd = function (map) { // when info control is added to map
                    // Create a div to hold the info box with a class name of "info"
                    var div = L.DomUtil.create('div', 'poly-info');
                    // return empty div to be added to map
                    return div;
                }
                // Add empty info div to map
            info.addTo(map);
            $(".poly-info").hide(); // hide empty info box until populated

        } // end drawInfo()


        function updateInfo(layer) {
            
            // Info pop-up box when hover over polygon on map

            // variable to access layer properties
            var data = layer.feature.properties;
            var alternative = data.Alternative;

            // Years for the Economic data
            var RCAeconYr = "1997-2001";
            var noRCAeconYr = "2011-2014";
            if (data.RegAction === "reopen") {
                noRCAeconYr = "1997-2001";
            }    
            
            if (selectableAlts.includes(alternative) || rcaAlts.includes(alternative)){
                var altTitle = "Alternative"
            } else {
                    altTitle = "Proposer"
            }
            
            // populate html variable with header - Site name
            // and values for the specified attributes using the 
            // layer (feature) that was passed to this function
            var html = "<h3>" + data.SiteName + "</h3>" // +
            html += "<br>" + "<b>Action: </b>" + data.RegAction;
            html += "<br>" + "<b>" + altTitle + ": </b>" + alternative;
            html += "<br>" + "<b>Area (sq mi): </b>" + fmt4table(data.SiteAreaMi2);
            if (selectableAlts.includes(alternative) || rcaAlts.includes(alternative)){
                html += "<br>" + "<b>Hard Substrate: </b>" + pct(data.hard, data.SiteAreaMi2);
                html += "<br>" + "<b>Mixed Substrate: </b>" + pct(data.mixed, data.SiteAreaMi2);
                html += "<br>" + "<b>Soft Substrate: </b>" + pct(data.soft, data.SiteAreaMi2);
                html += "<br>" + "<b>Unknown Substrate: </b>" + pct(data.unknown, data.SiteAreaMi2);
                html += "<br>" + "<b>Canyons & Gullies: </b>" + pct(data.CynAreaMi2, data.SiteAreaMi2);
                html += "<br>" + "<b>Overfished Species: </b> " + pct(data.OF80AreaMi2, data.SiteAreaMi2);
                html += "<br>" + "<b>Coral Presence</b> (1 km cells): " + data.coral_cnt;
                html += "<br>" + "<b>Sponge Presence</b> (1 km cells): " + data.sponge_cnt;
                html += "<br>" + "<b>Sea Pen Presence</b> (1 km cells): " + data.penn_cnt;
                html += "<br>" + "<b>Coral Bycatch</b> (.5 km cells): " + data.coralthreshold_count;
                html += "<br>" + "<b>Sponge Bycatch</b> (.5 km cells): " + data.spongethreshold_count;
                html += "<br>" + "<b>Sea Pen Bycatch</b> (.5 km cells): " + data.pennthreshold_count;
            }
            if (selectableAlts.includes(alternative)) {
                html += "<br>" + "<b>Outside RCA</b> (" + noRCAeconYr + "):";
                html += "<br>" + "&emsp;<b>Landings</b> (lbs): " + cfd4table(data.LWlb_outRCA, 'landings');
                html += "<br>" + "&emsp;<b>Ex-Vessel Revenue: </b>: " + cfd4table(data.Rev_outRCA, 'dollars');
                html += "<br>" + "<b>Inside RCA</b> (" + RCAeconYr + "):";
                html += "<br>" + "&emsp;<b>Landings</b> (lbs): " + cfd4table(data.LWlb_inRCA, 'landings');
                html += "<br>" + "&emsp;<b>Ex-Vessel Revenue</b>: " + cfd4table(data.Rev_inRCA, 'dollars');
                html += "<br>" + "** indicates confidential data";
//            html += "<br>" + "<b>Conserv. Value Mean: </b> " + rnd(data.consval_mean, 2);
//            html += "<br>" + "<b>Conserv. Value Variance: </b> " + rnd(data.consval_var, 2); 
            }

            // Assign the html content to the info box using JQuery selector
            $(".poly-info").html(html);

        } // end updateInfo()

        function buildUI() {
            
            // Perform following actions When the DOM object with id of "ui-controls" is changed
            // i.e., the user selects an option from the HTML form
            $('#ui-controls button').click(function () {
                // Set attribute to user selection from pull-down menu
                attribute = $(this).val();
                // Re-draw map with new attribute
                if (attribute === "Zoom" && Object.keys(selectedSet).length > 0) {
                    zoomToSelected();
                }
                if (attribute === "Clear") {
                    clearSelected();
                }

            });

            // Toggle layers on and off
            $('#layer-controls input').change(function () {

                var targetLayer = $(this).val();
                var icon = $('label[for='+targetLayer+']').find('.layer-selection-icon');
                var selBtn = $('label[for='+targetLayer+']').find('.layer-select-all');
                var unselBtn = $('label[for='+targetLayer+']').find('.layer-unselect-all');
                if (this.checked) {
                    icon.removeClass('fa-square-o').addClass('fa-check-square-o');
                    map.addLayer(geoJsonLayers[targetLayer]);
                    // enable select and unselect all buttons
                    selBtn.prop('disabled', false);
                    unselBtn.prop('disabled', false);
                } else {
                    icon.removeClass('fa-check-square-o').addClass('fa-square-o');
                    map.removeLayer(geoJsonLayers[targetLayer]);
                    // disable select and unselect all buttons
                    selBtn.prop('disabled', true);
                    unselBtn.prop('disabled', true);  
                }

            });
            
            // Select all polygons from a Proposal, regardless of current state
            $('.layer-select-all').on('click', function () {
                loading(true);
                var targetLayer = $(this).parent().attr('for');
                setTimeout(function() {
                    geoJsonLayers[targetLayer].eachLayer(function(f){
                        var id = f.feature.properties.concat_id;
                        // Only add features that are not already selected
                        if (! (selectedSet.hasOwnProperty(id)) ){
                            selected(f); 
                        }                      
                    });
                    loading(false);
                }, 1);
            });
            
            
            // Remove all polygons from a Proposal
            $('.layer-unselect-all').on('click', function () {
                var $parent = $(this).parent();
                var targetLayer = $parent.attr('for');
                loading(true);
                setTimeout(function() {
                    geoJsonLayers[targetLayer].eachLayer(function(f){
                        unselected(f);                     
                    });
                    $parent.find('.layer-counter-current').html(0); // hard set the current layer counter to 0
                    loading(false);
                }, 1);
            });
            

            $('#panel-tabs button').on('click', function () {
                
                // Updates when one of the tabs on the left panel is clicked
                var elem = $(this); // the button that was clicked
                var id = $(this).val(); // the button value  = the id of for the panel content
                // Change clicked item to selected
                elem.addClass('selected');
                // Unselect other buttons
                elem.siblings().removeClass('selected');
                // Hide content from unselected tabs
                elem.siblings().each(function () {
                        var sib_id = $(this).val()
                        $('#'.concat(sib_id)).hide();
                    })
                    // Show content from selected tab
                $('#'.concat(id)).show();
            });
            
            
            // constructs the polygon search suggestion engine
            var sites = new Bloodhound({
              datumTokenizer: Bloodhound.tokenizers.whitespace,
              queryTokenizer: Bloodhound.tokenizers.whitespace,
              // array of EFH polygon names
              local: poly_names
            });

            $('#poly-search .typeahead').typeahead({
              hint: true,
              highlight: true,
              minLength: 1
            },
            {
              name: 'efhpoly',
              source: sites,
              limit: 10
            });
            
            // Return the selected value from the polygon search box
            
            $('#poly-search .typeahead').bind('typeahead:select', function(ev, suggestion) {
                zoom2Name(suggestion);
            });
            
            
        }  // end buildUI{}
        
        // Zoom to a polygon by name
        function zoom2Name(sitename) {
            map.fitBounds(poly_bounds[sitename])
        }

        // Convert sq meters to square miles and format nicely
        function sqm2sqmi(val) {
            var sqmi = val / 2589988.11
            if (Math.abs(sqmi) >= 0.5 || sqmi == 0 ) {
                return (val / 2589988.11).toLocaleString(undefined, {
                    maximumFractionDigits: 0
                })
            } else {
                return "<1"
            }
        }
        
        // Format area values for the HTML table
        function fmt4table(val) {
            if (Math.abs(val) >= 0.5 || val == 0 ) {
                return (val).toLocaleString(undefined, {
                    maximumFractionDigits: 0
                })
            } else {
                return "<1"
            }
        }

        // Convert meters to miles and format nicely
        function m2mi(val) {
            return (val / 1609.344).toLocaleString(undefined, {
                maximumFractionDigits: 0
            })
        }

        // Calculate percentage or return zero if denominator is zero
        function pct(num, denom) {
            if (denom == 0 || !(num) || num == 0) {
                return "0%";
            } else if ( (num / denom) < 0.01 ) {
                return "<1%";
            } else {
                return (num / denom).toLocaleString(undefined, {
                    style: 'percent'
                });
            }
        }
        
        // Format proportion as percent
        function prop2pct(val, digits){
            if (val == 0){
                digits = 0
            }
            return val.toLocaleString(undefined, {
                style: 'percent',
                minimumFractionDigits: digits,
            });
        }
        
        // Round and Format to specified number of decimals
        function rnd(val, digits){
            return val.toLocaleString(undefined, {
                maximumFractionDigits: digits,
                minimumFractionDigits: digits,
            })
        }
        
        // Round to even dollars
        function dollars(val){
            return val.toLocaleString(undefined, {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0,
            });
        }
        
        // Handle confidential data, where -1 indicates confidential
        function cfd4table(val,type){
            if (val == -1){
                return "**";
            } else if (val >= 0){
                if (type == 'dollars'){
                    return dollars(val);
                } else if (type == 'landings'){
                    return rnd(val,0)
                } else if (type == 'percent')
                    return prop2pct(val, 4)
            } else {
                return "unknown";
            }
        }
        
        function buildSummary() {

            // Remove starter text
            $('.start-text').hide();
            
            // Header for Polygon count
            $('#poly-count').text("(0)");

            // shortcut to our table element
            var $table = $('#summary-metrics'),
                rows = '';

            // Create empty table structure
            rows += '<tr class="table-row-header"><th>Environmental Metrics</th>' + '<th>Close</th>' + '<th>Open</th>' + '<th>Net</th></tr>' +
                '<tr><td>Area (sq mi)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><th>Substrate Type</th>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Hard</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Mixed</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Soft</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Unknown</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><th>Priority Habitats</th>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Canyons & Gullies</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>OFS (sq mi) </td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><th>Habitat-Forming Invertebrates</th>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Coral Presence (1 km cells)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Sponge Presence (1 km cells)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Sea Pen Presence (1 km cells)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Coral Bycatch (.5 km cells)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Sponge Bycatch (.5 km cells)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Sea Pen Bycatch (.5 km cells)</td>' + '<td></td>' + '<td></td>' + '<td></td></tr>';
                    
            // update the html of the table
            $table.html(rows);

        }

        
        function updateSummmary() {
            // use selectedSet to summarize Data

            // List of metric attributes
            var metric_attributes = [
                "SiteAreaMi2",
                "hard",
                "mixed",
                "soft",
                "unknown",
                "CynAreaMi2",
                "OF80AreaMi2",          
                "coral_cnt",,
                "sponge_cnt",
                "penn_cnt",
                "coralthreshold_count",
                "spongethreshold_count",
                "pennthreshold_count",
            ]


            var polyData = []; // individual polygon attributes

            // Initialize Summary Data objects with zeros for all metrics
            var summOpen = {
                SiteAreaMi2: 0,
                hard: 0,
                mixed: 0,
                soft: 0,
                unknown: 0,
                CynAreaMi2: 0,
                OF80AreaMi2: 0,    
                coral_cnt: 0,
                sponge_cnt: 0,
                penn_cnt: 0,
                coralthreshold_count: 0,
                spongethreshold_count: 0,
                pennthreshold_count: 0,
            };
            var summClose = {
                SiteAreaMi2: 0,
                hard: 0,
                mixed: 0,
                soft: 0,
                unknown: 0,
                CynAreaMi2: 0,
                OF80AreaMi2: 0,    
                coral_cnt: 0,
                sponge_cnt: 0,
                penn_cnt: 0,
                coralthreshold_count: 0,
                spongethreshold_count: 0,
                pennthreshold_count: 0,
            };

            // loop through all the selected features
            for ( var i in selectedSet ){
                
                var selection = selectedSet[i];
                var props = selection.feature.properties;

                // Add individual polygon metrics to polyData list
                polyData.push(props);

                // loop through the properties
                for (var att in props) {

                    // Only use metrics of interest
                    if (metric_attributes.indexOf(att) >= 0) {
                        // if it's a number
                        if (Number(props[att])) {

                            // Areas to be closed
                            if (props.RegAction === "close") {
                                summClose[att] += props[att];
                            } else { // areas to be reopened
                                summOpen[att] += props[att];
                            }
                        }
                    }
                }
                

            } // end of loop through selectedSet
            
            
            // Update area count text
            var polyCount = Object.keys(selectedSet).length;

            // Activate or de-activate zoom and clear buttons depending on presence of selection
            if (polyCount == 0) {
                $('#zoom').removeClass('available');
                $('#clear').removeClass('available');
            } else {
                $('#zoom').addClass('available');
                $('#clear').addClass('available');
            }


            if (polyCount == 1) {
                $('#poly-count').text("(" + polyCount + ")")
            } else {
                $('#poly-count').text("(" + polyCount + ")")
            }

            // Remove starter text
            $('.start-text').hide();
            
            // shortcut to our table element
            var $table = $('#summary-metrics'),
                rows = '';

            // Variables for frequently used metrics
            var areaClose = summClose.SiteAreaMi2;
            var areaOpen = summOpen.SiteAreaMi2;
            var areaNet = areaClose - areaOpen;

            // Populate the table
            rows += '<tr class="table-row-header"><th>Environmental Metrics</th>' + '<th>Close</th>' + '<th>Open</th>' + '<th>Net</th></tr>' +
                '<tr><td>Area (sq mi)</td>' + '<td>' + fmt4table(areaClose) + '</td>' +
                '<td>' + fmt4table(areaOpen) + '</td>' +
                '<td>' + fmt4table(areaNet) + '</td></tr>' +
                '<tr><th>Substrate Type</th><td></td><td></td><td></td></tr>' +
                '<tr><td>Hard (sq mi) </td>' + '<td>' + fmt4table(summClose.hard) + '</td>' +
                '<td>' + fmt4table(summOpen.hard) + '</td>' +
                '<td>' + fmt4table(calcNet(summClose.hard, summOpen.hard)) + '</td></tr>' +
                '<tr><td>Mixed (sq mi) </td>' + '<td>' + fmt4table(summClose.mixed) + '</td>' +
                '<td>' + fmt4table(summOpen.mixed) + '</td>' +
                '<td>' + fmt4table(calcNet(summClose.mixed, summOpen.mixed)) + '</td></tr>' +
                '<tr><td>Soft (sq mi) </td>' + '<td>' + fmt4table(summClose.soft) + '</td>' +
                '<td>' + fmt4table(summOpen.soft, areaOpen) + '</td>' +
                '<td>' + fmt4table(calcNet(summClose.soft, summOpen.soft), areaNet) + '</td></tr>' +
                '<tr><td>Unknown (sq mi) </td>' + '<td>' + fmt4table(summClose.unknown) + '</td>' +
                '<td>' + fmt4table(summOpen.unknown, areaOpen) + '</td>' +
                '<td>' + fmt4table(calcNet(summClose.unknown, summOpen.unknown), areaNet) + '</td></tr>' +
                '<tr><th>Priority Habitats</th><td></td><td></td><td></td></tr>' +
                '<tr><td>Canyons & Gullies  (sq mi) </td>' + '<td>' + fmt4table(summClose.CynAreaMi2) + '</td>' +
                '<td>' + fmt4table(summOpen.CynAreaMi2, areaOpen) + '</td>' +
                '<td>' + fmt4table(calcNet(summClose.CynAreaMi2, summOpen.CynAreaMi2), areaNet) + '</td></tr>' +
                '<tr><td>OFS (sq mi) </td>' + '<td>' + fmt4table(summClose.OF80AreaMi2) + '</td>' +
                '<td>' + fmt4table(summOpen.OF80AreaMi2, areaOpen) + '</td>' +
                '<td>' + fmt4table(calcNet(summClose.OF80AreaMi2, summOpen.OF80AreaMi2), areaNet) + '</td></tr>' +
                '<tr><th>Habitat-Forming Invertebrates</th>' + '<td></td>' + '<td></td>' + '<td></td></tr>' +
                '<tr><td>Coral Presence (1 km cells)</td>' + '<td>' + summClose.coral_cnt + '</td>' +
                '<td>' + summOpen.coral_cnt + '</td>' +
                '<td>' + calcNet(summClose.coral_cnt, summOpen.coral_cnt) + '</td></tr>' +
                '<tr><td>Sponge Presence (1 km cells)</td>' + '<td>' + summClose.sponge_cnt + '</td>' +
                '<td>' + summOpen.sponge_cnt + '</td>' +
                '<td>' + calcNet(summClose.sponge_cnt, summOpen.sponge_cnt) + '</td></tr>' +
                '<tr><td>Sea Pen Presence (1 km cells)</td>' + '<td>' + summClose.penn_cnt + '</td>' +
                '<td>' + summOpen.penn_cnt + '</td>' +
                '<td>' + calcNet(summClose.penn_cnt, summOpen.penn_cnt) + '</td></tr>' +
                '<tr><td>Coral Bycatch (.5 km cells)</td>' + '<td>' + summClose.coralthreshold_count + '</td>' +
                '<td>' + summOpen.coralthreshold_count + '</td>' +
                '<td>' + calcNet(summClose.coralthreshold_count, summOpen.coralthreshold_count) + '</td></tr>' +
                '<tr><td>Sponge Bycatch (.5 km cells)</td>' + '<td>' + summClose.spongethreshold_count + '</td>' +
                '<td>' + summOpen.spongethreshold_count + '</td>' +
                '<td>' + calcNet(summClose.spongethreshold_count, summOpen.spongethreshold_count) + '</td></tr>' +
                '<tr><td>Sea Pen Bycatch (.5 km cells)</td>' + '<td>' + summClose.pennthreshold_count + '</td>' +
                '<td>' + summOpen.pennthreshold_count + '</td>' +
                '<td>' + calcNet(summClose.pennthreshold_count, summOpen.pennthreshold_count) + '</td></tr>';
            
            // update the html of the table
            $table.html(rows);

            // update individual poly table with the selected set
            updatePolyTable();

        } // end updatedSummary()

        function calcNet(close, open) {

            // Calculate Net value from summary data values
            // Most values are just difference, but some, like Coral/Sponge block count will need additional logic
            return close - open;

        } // end calcNet

        function buildPolyTable() {
            // shortcut to our table element
            var $table = $('#polygon-metrics'),
                rows = '';

            // empty table structure
            rows += '<tr>' +
                '<th>Action</th>' +
                '<th>Site Name</th>' +
                '<th>Alternative</th>' +
                '<th>Area (sq mi)</th>' +
                '<th>Hard (sq mi)</th>' +
                '<th>Mixed (sq mi)</th>' +
                '<th>Soft (sq mi)</th>' +
                '<th>Unknown (sq mi)</th>' +
                '<th>Canyons & Gullies (sq mi)</th>' +
                '<th>OFS (sq mi)</th>' +              
                '<th>Coral Presence (1 km cells)</th>' +
                '<th>Sponge Presence (1 km cells)</th>' +
                '<th>Sea Pen Presence (1 km cells)</th>' +
                '<th>Coral Bycatch (.5 km cells)</th>' +
                '<th>Sponge Bycatch (.5 km cells)</th>' +
                '<th>Sea Pen Bycatch (0.5 km cells)</th>' +
                '<th>Landings, non-RCA (lbs)</th>' +
                '<th>Landings, non-RCA (% coastwide)</th>' +
                '<th>Landings, in RCA (lbs)</th>' +
                '<th>Landings, in RCA (% coastwide)</th>' +
                '<th>Ex-Vessel Revenue non-RCA (dollars)</th>' +
                '<th>Ex-Vessel Revenue non-RCA (% coastwide)</th>' +
                '<th>Ex-Vessel Revenue in RCA (dollars)</th>' +
                '<th>Ex-Vessel Revenue in RCA (% coastwide)</th>' + 
                '</tr>'

            // update the html of the table
            $table.html(rows);
            
            //  Hide the csv download button
            $('#download-csv').removeClass('show');

        }

        function updatePolyTable() {
            // Build content of Poly Table with selectedSet

            var $table = $('#polygon-metrics'),
                rows = '';

            // Table Headers
           rows += '<tr>' +
                '<th>Action</th>' +
                '<th>Site Name</th>' +
                '<th>Alternative</th>' +
                '<th>Area (sq mi)</th>' +
                '<th>Hard (sq mi)</th>' +
                '<th>Mixed (sq mi)</th>' +
                '<th>Soft (sq mi)</th>' +
                '<th>Unknown (sq mi)</th>' +
                '<th>Canyons & Gullies (sq mi)</th>' +
                '<th>OFS (sq mi)</th>' +
                '<th>Coral Presence (1 km cells)</th>' +
                '<th>Sponge Presence (1 km cells)</th>' +
                '<th>Sea Pen Presence (1 km cells)</th>' +
                '<th>Coral Bycatch (.5 km cells)</th>' +
                '<th>Sponge Bycatch (.5 km cells)</th>' +
                '<th>Sea Pen Bycatch (.5 km cells)</th>' +
                '<th>Landings, non-RCA (lbs)</th>' +
                '<th>Landings, non-RCA (% coastwide)</th>' +
                '<th>Landings, in RCA (lbs)</th>' +
                '<th>Landings, in RCA (% coastwide)</th>' +
                '<th>Ex-Vessel Revenue non-RCA (dollars)</th>' +
                '<th>Ex-Vessel Revenue non-RCA (% coastwide)</th>' +
                '<th>Ex-Vessel Revenue in RCA (dollars)</th>' +
                '<th>Ex-Vessel Revenue in RCA (% coastwide)</th>' + 
               '</tr>'

            // loop through all the selected features                
            for ( var i in selectedSet ){
                
                var selection = selectedSet[i];
                var data = selection.feature.properties;

//                // Tow Length filter (< 3 vessels in an area)
//                var towLen;
//                if (data.VesCount >= 3 || data.VesCount == 0) {
//                    towLen = m2mi(data.TowLenM);
//                    
//                } else {
//                    towLen = "**";
//                }

                rows += '<tr>' +
                    '<td>' + data.RegAction + '</td>' +
                    '<td>' + data.SiteName + '</td>' +
                    '<td>' + data.Alternative + '</td>' +
                    '<td>' + fmt4table(data.SiteAreaMi2) + '</td>' +
                    '<td>' + fmt4table(data.hard) + '</td>' +
                    '<td>' + fmt4table(data.mixed) + '</td>' +
                    '<td>' + fmt4table(data.soft) + '</td>' +
                    '<td>' + fmt4table(data.unknown) + '</td>' +
                    '<td>' + fmt4table(data.CynAreaMi2) + '</td>' +
                    '<td>' + fmt4table(data.OF80AreaMi2) + '</td>' +              
                    '<td>' + data.coral_cnt + '</td>' +
                    '<td>' + data.sponge_cnt + '</td>' +
                    '<td>' + data.penn_cnt + '</td>' +
                    '<td>' + data.coralthreshold_count + '</td>' +
                    '<td>' + data.spongethreshold_count + '</td>' +
                    '<td>' + data.pennthreshold_count + '</td>' +
                    '<td>' + cfd4table(data.LWlb_outRCA, 'landings') + '</td>' +
                    '<td>' + cfd4table(data.LWprop_outRCA, 'percent') + '</td>' +
                    '<td>' + cfd4table(data.LWlb_inRCA, 'landings') + '</td>' +
                    '<td>' + cfd4table(data.LWprop_inRCA, 'percent') + '</td>' +
                    '<td>' + cfd4table(data.Rev_outRCA, 'dollars') + '</td>' +
                    '<td>' + cfd4table(data.Revprop_outRCA, 'percent') + '</td>' +
                    '<td>' + cfd4table(data.Rev_inRCA, 'dollars') + '</td>' +
                    '<td>' + cfd4table(data.Revprop_inRCA, 'percent') + '</td>' +
                    '</tr>'
//                rows += '</tr>'
                
            } // end of loop through selectedSet

            // update the html of the table
            $table.html(rows);
            
            $('#download-csv').addClass('show');
//            $('#download-csv').css('visibility','visible');


        } // end of updatePolyTable()

        // adds or removes a loader icon at the top-right of the page
        function loading(boolean) {
            if (boolean) $('html').addClass('loading');
            else $('html').removeClass('loading');
        }

        (function () {

            $("#download-csv").click(function () {
                $('#polygon-metrics').tableToCSV();
            });

        })();
        
    </script>

</body>

</html>